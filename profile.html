<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - JBR7 Bags Manufacturing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="home.css">
    <link rel="stylesheet" href="JBR7 CSS/profile.css">
</head>
<body>
    <header>
        <a href="home.html" class="logo">
            <img src="JBR7 BAGS LOGO.jpg" alt="JBR7 BAGS LOGO" class="logo-img" onerror="this.style.display='none'">
            <div class="logo-text">
                <h2><span>JBR7</span> BAGS</h2>
                <span class="sub-logo">MANUFACTURING</span>
            </div>
        </a>
        <div class="header-sep" aria-hidden="true"></div>
        <nav>
            <a href="home.html" onclick="handleNavigate('home'); return false;" data-page="home" class="active"><i class="fas fa-home"></i> Home</a>
            <a href="explore.html" onclick="handleNavigate('explore'); return false;" data-page="explore"><i class="fas fa-compass"></i> Explore</a>
            <a href="saved.html" onclick="handleNavigate('saved'); return false;" data-page="saved"><i class="fas fa-bookmark"></i> Saved</a>
            <a href="cart.html" onclick="handleNavigate('cart'); return false;" data-page="cart"><i class="fas fa-shopping-cart"></i> Cart</a>
            <a href="contact.html" onclick="handleNavigate('contact'); return false;" data-page="contact"><i class="fas fa-envelope"></i> Contact Us</a>
            <a href="settings.html" onclick="handleNavigate('settings'); return false;" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
            <a href="#" onclick="handleNavigate('search'); return false;" data-page="search"><i class="fas fa-search"></i></a>
            <a href="#" onclick="handleNavigate('notifications'); return false;" data-page="notifications"><i class="fas fa-bell"></i></a>
            <a href="#" onclick="handleNavigate('messages'); return false;" data-page="messages"><i class="fas fa-comment"></i></a>
            <a href="profile.html" onclick="handleNavigate('profile'); return false;" data-page="profile"><i class="fas fa-user-circle"></i></a>
        </nav>
    </header>

    <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-cover"></div>
            <div class="profile-info-wrapper">
                <div class="profile-avatar-section">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <button class="edit-avatar-btn" onclick="editAvatar()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="profile-details">
                    <h1 class="profile-name">John Doe</h1>
                    <p class="profile-email"><i class="fas fa-envelope"></i> john.doe@example.com</p>
                    <p class="profile-member-since"><i class="fas fa-calendar-alt"></i> Member since January 2024</p>
                    <div class="profile-actions">
                        <button class="btn-primary" onclick="handleNavigate('settings')">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button class="btn-secondary" onclick="shareProfile()">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Stats -->
        <div class="profile-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">24</h3>
                    <p class="stat-label">Total Orders</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">12</h3>
                    <p class="stat-label">Saved Items</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">8</h3>
                    <p class="stat-label">Favorites</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">15</h3>
                    <p class="stat-label">Reviews</p>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="profile-content">
            
            <!-- Sidebar -->
            <div class="profile-sidebar">
                <div class="profile-menu">
                    <button class="profile-menu-item active" onclick="showProfileSection('orders')" data-section="orders">
                        <i class="fas fa-box"></i>
                        <span>My Orders</span>
                    </button>
                    <button class="profile-menu-item" onclick="showProfileSection('reviews')" data-section="reviews">
                        <i class="fas fa-star"></i>
                        <span>My Reviews</span>
                    </button>
                    <button class="profile-menu-item" onclick="showProfileSection('rewards')" data-section="rewards">
                        <i class="fas fa-gift"></i>
                        <span>Rewards</span>
                    </button>
                    <button class="profile-menu-item" onclick="showProfileSection('activity')" data-section="activity">
                        <i class="fas fa-history"></i>
                        <span>Activity</span>
                    </button>
                    <button class="profile-menu-item logout-item" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>

                <!-- Loyalty Card -->
                <div class="loyalty-card">
                    <div class="loyalty-header">
                        <i class="fas fa-crown"></i>
                        <span>Gold Member</span>
                    </div>
                    <div class="loyalty-points">
                        <h3>2,450</h3>
                        <p>Loyalty Points</p>
                    </div>
                    <div class="loyalty-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%;"></div>
                        </div>
                        <p>550 points to Platinum</p>
                    </div>
                    <button class="loyalty-btn" onclick="viewRewards()">View Rewards</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="profile-main">
                
                <div class="profile-section active" id="orders-section">
    <div class="section-header">
        <h2>My Orders</h2>
        <div class="order-filters">
            <button class="filter-btn active" onclick="filterOrders('all')" id="filterAll">All</button>
            <button class="filter-btn" onclick="filterOrders('processing')" id="filterProcessing">Processing</button>
            <button class="filter-btn" onclick="filterOrders('shipped')" id="filterShipped">Shipped</button>
            <button class="filter-btn" onclick="filterOrders('delivered')" id="filterDelivered">Delivered</button>
        </div>
    </div>
    
    <div class="orders-list" id="ordersList">
        <p style="text-align: center; padding: 2rem; color: #6b7280;">Loading orders...</p>
    </div>
</div>

<!-- Reviews Section -->
<div class="profile-section" id="reviews-section">
    <div class="section-header">
        <h2>My Reviews</h2>
    </div>

    <div class="reviews-list section-scroll" id="userReviewsList">
        <p style="text-align: center; padding: 2rem; color: #6b7280;">Loading reviews...</p>
    </div>
</div>

<!-- Rewards Section -->
<div class="profile-section" id="rewards-section">
    <div class="section-header">
        <h2>Rewards & Points</h2>
    </div>

    <div class="section-scroll rewards-scroll">
        <div class="rewards-summary">
            <div class="rewards-card-large">
                <div class="rewards-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h3>2,450 Points</h3>
                <p>Available to redeem</p>
                <button class="btn-primary" onclick="redeemPoints()">Redeem Points</button>
            </div>
        </div>
        
        <div class="rewards-available">
            <h3>Available Rewards</h3>
            <div class="rewards-grid">
                <div class="reward-item">
                    <div class="reward-icon"><i class="fas fa-tag"></i></div>
                    <h4>10% Off Coupon</h4>
                    <p class="reward-cost">500 points</p>
                    <button class="btn-secondary" onclick="claimReward(500)">Claim</button>
                </div>
                <div class="reward-item">
                    <div class="reward-icon"><i class="fas fa-shipping-fast"></i></div>
                    <h4>Free Shipping</h4>
                    <p class="reward-cost">300 points</p>
                    <button class="btn-secondary" onclick="claimReward(300)">Claim</button>
                </div>
                <div class="reward-item">
                    <div class="reward-icon"><i class="fas fa-percent"></i></div>
                    <h4>20% Off Coupon</h4>
                    <p class="reward-cost">1000 points</p>
                    <button class="btn-secondary" onclick="claimReward(1000)">Claim</button>
                </div>
                <div class="reward-item">
                    <div class="reward-icon"><i class="fas fa-gift"></i></div>
                    <h4>Free Custom Logo</h4>
                    <p class="reward-cost">800 points</p>
                    <button class="btn-secondary" onclick="claimReward(800)">Claim</button>
                </div>
            </div>
        </div>
        
        <div class="points-history">
            <h3>Points History</h3>
            <div class="history-item">
                <div class="history-info">
                    <strong>Order Purchase</strong>
                    <span>December 20, 2024</span>
                </div>
                <span class="points-earned">+150 pts</span>
            </div>
            <div class="history-item">
                <div class="history-info">
                    <strong>Product Review</strong>
                    <span>December 21, 2024</span>
                </div>
                <span class="points-earned">+50 pts</span>
            </div>
            <div class="history-item">
                <div class="history-info">
                    <strong>Redeemed: 10% Off Coupon</strong>
                    <span>December 18, 2024</span>
                </div>
                <span class="points-redeemed">-500 pts</span>
            </div>
        </div>
    </div>
</div>

<!-- Activity Section -->
<div class="profile-section" id="activity-section">
    <div class="section-header">
        <h2>Recent Activity</h2>
    </div>

    <div class="activity-timeline section-scroll" id="activityList">
        <p style="text-align: center; padding: 2rem; color: #6b7280;">Loading activities...</p>
    </div>
</div>

</div>
</div>
</div>

<footer>
    <div class="footer-content">
        <div class="footer-section">
            <h3>JBR7 BAGS</h3>
            <p>Manufacturing quality bags since day one.</p>
        </div>
        <div class="footer-section">
            <h4>Quick Links</h4>
            <ul>
                <li><span onclick="handleFooterNavigate('about')">About Us</span></li>
                <li><span onclick="handleFooterNavigate('products')">Products</span></li>
                <li><span onclick="handleFooterNavigate('contact')">Contact</span></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Contact Info</h4>
            <p>Email: roquejennylynbatac@gmail.com</p>
            <p>Phone: +639216821649</p>
        </div>
        <div class="footer-section">
            <h4>Follow Us</h4>
            <div class="social-icons">
                <span onclick="handleSocialClick('facebook')"><i class="fab fa-facebook"></i></span>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 JBR7 Bags Manufacturing. All rights reserved.</p>
    </div>
</footer>
              
    
    
    <!-- Profile orders/filter use profile.js (getUserId, renderOrders = populateOrders); session checked so no refresh unless user refreshes -->
    <script>
        let currentStatusFilter = 'all';
        let allOrders = [];

        function apiFetch(url, options) {
            const opts = options || {};
            const headers = opts.headers ? { ...opts.headers } : {};
            const uid = typeof getUserId === 'function' ? getUserId() : sessionStorage.getItem('jbr7_user_id');
            if (uid) headers['X-User-Id'] = uid;
            return fetch(url, { ...opts, headers });
        }

        async function loadOrders(status = null) {
    const container = document.getElementById('ordersList');
    if (!container) return;
    const userId = typeof getUserId === 'function' ? getUserId() : sessionStorage.getItem('jbr7_user_id');
    if (!userId) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #dc2626;">Please log in to view orders.</p>';
        return;
    }
    container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">Loading orders...</p>';

    try {
        // FIXED: Changed endpoint
        const url = status ? `/api/get?action=orders&userId=${userId}&status=${status}` : `/api/get?action=orders&userId=${userId}`;
        console.log('Fetching orders from:', url);
        const response = await fetch(url, { credentials: 'same-origin' });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Failed to load orders:', response.status, errorText);
            container.innerHTML = `<p style="text-align: center; padding: 2rem; color: #dc2626;">Failed to load orders (${response.status}). Please check if you are logged in.</p>`;
            return;
        }

        const data = await response.json();
        console.log('Orders data received:', data);
        
        if (data.success && data.orders) {
            allOrders = data.orders;
            if (data.orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No orders found. Start shopping to see your orders here!</p>';
            } else {
                renderOrders(data.orders);
            }
        } else {
            console.warn('No orders in response:', data);
            container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No orders found.</p>';
        }
    } catch (e) {
        console.error('Failed to load orders', e);
        container.innerHTML = `<p style="text-align: center; padding: 2rem; color: #dc2626;">Error loading orders: ${e.message}</p>`;
    }
}

// 2. REPLACE cancelOrder function (around line 487)
async function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) return;

    const userId = sessionStorage.getItem('jbr7_user_id');
    if (!userId) {
        alert('Please log in first');
        return;
    }

    try {
        // FIXED: Changed endpoint and payload
        const response = await fetch('/api/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'cancel-order',
                userId: userId,
                orderId: orderId 
            })
        });

        const data = await response.json();
        if (data.success) {
            alert('Order cancelled successfully');
            loadOrders(currentStatusFilter === 'all' ? null : currentStatusFilter);
        } else {
            alert(data.error || 'Failed to cancel order');
        }
    } catch (e) {
        console.error('Failed to cancel order', e);
        alert('Failed to cancel order');
    }
}

// 3. REMOVE the setInterval that calls /api/update_order_status (around line 527)
// DELETE or COMMENT OUT this entire block:
/*
setInterval(() => {
    apiFetch('/api/update_order_status', { credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
            if (data.success && (data.updated.shipped > 0 || data.updated.delivered > 0)) {
                loadOrders(currentStatusFilter === 'all' ? null : currentStatusFilter);
            }
        })
        .catch(e => console.error('Status update failed', e));
}, 5000);
*/

// 4. REPLACE loadUserReviews function (around line 539)
async function loadUserReviews() {
    const reviewsList = document.getElementById('userReviewsList');
    if (!reviewsList) return;

    const userId = sessionStorage.getItem('jbr7_user_id');
    if (!userId) {
        reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">Please log in to view your reviews.</p>';
        return;
    }
    
    try {
        // FIXED: Changed endpoint
        const response = await fetch(`/api/get?action=user-reviews&userId=${userId}`, {
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">Please log in to view your reviews.</p>';
                return;
            }
            throw new Error('Failed to fetch reviews');
        }
        
        const data = await response.json();
        if (data.success && data.reviews) {
            renderUserReviews(data.reviews);
        } else {
            reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No reviews yet.</p>';
        }
    } catch (e) {
        console.error('Failed to load reviews:', e);
        reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #dc2626;">Failed to load reviews.</p>';
    }
}

// 5. REPLACE loadUserActivities function (around line 636)
async function loadUserActivities() {
    const userId = sessionStorage.getItem('jbr7_user_id');
    if (!userId) return;

    try {
        // FIXED: Changed endpoint
        const response = await fetch(`/api/get?action=user-activities&userId=${userId}`, {
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                return; // Not authenticated
            }
            throw new Error('Failed to fetch activities');
        }
        
        const data = await response.json();
        if (data.success) {
            // Update points display
            const pointsEl = document.querySelector('.loyalty-points h3');
            if (pointsEl) {
                pointsEl.textContent = data.points.toLocaleString();
            }
            
            // Update rewards section points
            const rewardsPointsEl = document.querySelector('.rewards-card-large h3');
            if (rewardsPointsEl) {
                rewardsPointsEl.textContent = data.points.toLocaleString() + ' Points';
            }
            
            // Update activity history
            renderActivities(data.activities || []);
        }
    } catch (e) {
        console.error('Failed to load activities:', e);
    }
}

        function renderActivities(activities) {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;
            
            if (activities.length === 0) {
                activityList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No activities yet.</p>';
                return;
            }
            
            activityList.innerHTML = '';
            activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const iconClass = activity.type === 'order' ? 'added' : 
                                 activity.type === 'review' ? 'reviewed' : 'saved';
                const icon = activity.type === 'order' ? 'fa-cart-plus' :
                            activity.type === 'review' ? 'fa-star' : 'fa-heart';
                
                activityItem.innerHTML = `
                    <div class="activity-icon ${iconClass}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <strong>${activity.description || activity.type}</strong>
                        <span class="activity-time">${activity.time_ago || activity.date}</span>
                    </div>
                    <div class="activity-points">+${activity.points} pts</div>
                `;
                activityList.appendChild(activityItem);
            });
        }

        // Run only when DOM and profile.js are ready; use session so we don't run without user
        document.addEventListener('DOMContentLoaded', () => {
            var uid = typeof getUserId === 'function' ? getUserId() : sessionStorage.getItem('jbr7_user_id');
            if (uid) loadOrders();
            var filterAll = document.getElementById('filterAll');
            if (filterAll) {
                filterAll.classList.remove('btn-secondary');
                filterAll.classList.add('btn-primary');
            }
        });
    </script>
   <script src="jbr7js/user-storage.js"></script>
   <script src="jbr7js/home.js"></script>
   <script src="jbr7js/notifications.js"></script>
   <script src="jbr7js/profile.js"></script>
   
</body>
</html>
