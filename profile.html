<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - JBR7 Bags Manufacturing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="home.css">
    <link rel="stylesheet" href="JBR7 CSS/profile.css">
</head>
<body>
    <header>
        <a href="home.html" class="logo">
            <img src="JBR7 BAGS LOGO.jpg" alt="JBR7 BAGS LOGO" class="logo-img" onerror="this.style.display='none'">
            <div class="logo-text">
                <h2><span>JBR7</span> BAGS</h2>
                <span class="sub-logo">MANUFACTURING</span>
            </div>
        </a>
        <div class="header-sep" aria-hidden="true"></div>
        <nav>
            <a href="#home" onclick="handleNavigate('home')" data-page="home" class="active"><i class="fas fa-home"></i> Home</a>
            <a href="#explore" onclick="handleNavigate('explore')" data-page="explore"><i class="fas fa-compass"></i> Explore</a>
            <a href="#saved" onclick="handleNavigate('saved')" data-page="saved"><i class="fas fa-bookmark"></i> Saved</a>
            <a href="#cart" onclick="handleNavigate('cart')" data-page="cart"><i class="fas fa-shopping-cart"></i> Cart</a>
            <a href="#contact" onclick="handleNavigate('contact')" data-page="contact"><i class="fas fa-envelope"></i> Contact Us</a>
            <a href="#settings" onclick="handleNavigate('settings')" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
            <a href="#search" onclick="handleNavigate('search')" data-page="search"><i class="fas fa-search"></i></a>
            <a href="#notifications" onclick="handleNavigate('notifications')" data-page="notifications"><i class="fas fa-bell"></i></a>
            <a href="#messages" onclick="handleNavigate('messages')" data-page="messages"><i class="fas fa-comment"></i></a>
            <a href="#profile" onclick="handleNavigate('profile')" data-page="profile"><i class="fas fa-user-circle"></i></a>
        </nav>
    </header>

    <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-cover"></div>
            <div class="profile-info-wrapper">
                <div class="profile-avatar-section">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <button class="edit-avatar-btn" onclick="editAvatar()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="profile-details">
                    <h1 class="profile-name">John Doe</h1>
                    <p class="profile-email"><i class="fas fa-envelope"></i> john.doe@example.com</p>
                    <p class="profile-member-since"><i class="fas fa-calendar-alt"></i> Member since January 2024</p>
                    <div class="profile-actions">
                        <button class="btn-primary" onclick="handleNavigate('settings')">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button class="btn-secondary" onclick="shareProfile()">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Stats -->
        <div class="profile-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">24</h3>
                    <p class="stat-label">Total Orders</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">12</h3>
                    <p class="stat-label">Saved Items</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">8</h3>
                    <p class="stat-label">Favorites</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-number">15</h3>
                    <p class="stat-label">Reviews</p>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="profile-content">
            
            <!-- Sidebar -->
            <div class="profile-sidebar">
                <div class="profile-menu">
                    <button class="profile-menu-item active" onclick="showProfileSection('orders')" data-section="orders">
                        <i class="fas fa-box"></i>
                        <span>My Orders</span>
                    </button>
                    <button class="profile-menu-item" onclick="showProfileSection('wishlist')" data-section="wishlist">
                        <i class="fas fa-heart"></i>
                        <span>Wishlist</span>
                    </button>
                    <button class="profile-menu-item" onclick="showProfileSection('reviews')" data-section="reviews">
                        <i class="fas fa-star"></i>
                        <span>My Reviews</span>
                    </button>
                    <button class="profile-menu-item" onclick="showProfileSection('rewards')" data-section="rewards">
                        <i class="fas fa-gift"></i>
                        <span>Rewards</span>
                    </button>
                    <button class="profile-menu-item" onclick="showProfileSection('activity')" data-section="activity">
                        <i class="fas fa-history"></i>
                        <span>Activity</span>
                    </button>
                    <button class="profile-menu-item logout-item" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>

                <!-- Loyalty Card -->
                <div class="loyalty-card">
                    <div class="loyalty-header">
                        <i class="fas fa-crown"></i>
                        <span>Gold Member</span>
                    </div>
                    <div class="loyalty-points">
                        <h3>2,450</h3>
                        <p>Loyalty Points</p>
                    </div>
                    <div class="loyalty-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%;"></div>
                        </div>
                        <p>550 points to Platinum</p>
                    </div>
                    <button class="loyalty-btn" onclick="viewRewards()">View Rewards</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="profile-main">
                
                <div class="profile-section active" id="orders-section">
    <div class="section-header">
        <h2>My Orders</h2>
        <div class="order-filters">
            <button class="filter-btn active" onclick="filterOrders('all')" id="filterAll">All</button>
            <button class="filter-btn" onclick="filterOrders('processing')" id="filterProcessing">Processing</button>
            <button class="filter-btn" onclick="filterOrders('shipped')" id="filterShipped">Shipped</button>
            <button class="filter-btn" onclick="filterOrders('delivered')" id="filterDelivered">Delivered</button>
        </div>
    </div>
    
    <div class="orders-list" id="ordersList">
        <p style="text-align: center; padding: 2rem; color: #6b7280;">Loading orders...</p>
    </div>
</div>

<!-- Wishlist Section -->
<div class="profile-section" id="wishlist-section">
    <div class="section-header">
        <h2>My Wishlist</h2>
        <button class="btn-text" onclick="clearWishlist()">Clear All</button>
    </div>

    <div class="wishlist-grid">
        <!-- Items will be populated by JavaScript -->
    </div>
</div>

<!-- Reviews Section -->
<div class="profile-section" id="reviews-section">
    <div class="section-header">
        <h2>My Reviews</h2>
    </div>

    <div class="reviews-list" id="userReviewsList">
        <p style="text-align: center; padding: 2rem; color: #6b7280;">Loading reviews...</p>
    </div>
</div>

<!-- Rewards Section -->
<div class="profile-section" id="rewards-section">
    <div class="section-header">
        <h2>Rewards & Points</h2>
    </div>

    <div class="rewards-summary">
        <div class="rewards-card-large">
            <div class="rewards-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <h3>2,450 Points</h3>
            <p>Available to redeem</p>
            <button class="btn-primary" onclick="redeemPoints()">Redeem Points</button>
        </div>
    </div>

    <div class="rewards-available">
        <h3>Available Rewards</h3>
        <div class="rewards-grid">
            <div class="reward-item">
                <div class="reward-icon"><i class="fas fa-tag"></i></div>
                <h4>10% Off Coupon</h4>
                <p class="reward-cost">300 points</p>
                <button class="btn-secondary" onclick="claimReward(10)">Redeem</button>
            </div>
            <div class="reward-item">
                <div class="reward-icon"><i class="fas fa-percent"></i></div>
                <h4>20% Off Coupon</h4>
                <p class="reward-cost">600 points</p>
                <button class="btn-secondary" onclick="claimReward(20)">Redeem</button>
            </div>
            <div class="reward-item">
                <div class="reward-icon"><i class="fas fa-percent"></i></div>
                <h4>30% Off Coupon</h4>
                <p class="reward-cost">900 points</p>
                <button class="btn-secondary" onclick="claimReward(30)">Redeem</button>
            </div>
            <div class="reward-item">
                <div class="reward-icon"><i class="fas fa-gift"></i></div>
                <h4>50% Off Coupon</h4>
                <p class="reward-cost">1300 points</p>
                <button class="btn-secondary" onclick="claimReward(50)">Redeem</button>
            </div>
        </div>
    </div>

    <div class="redeemed-coupons-section" id="redeemed-coupons-section" style="display: none;">
        <h3>My Redeemed Coupons</h3>
        <div class="redeemed-coupons-list" id="redeemed-coupons-list">
            <!-- Redeemed coupons will be populated by JavaScript -->
        </div>
    </div>

    <div class="points-history">
        <h3>Points History</h3>
        <div class="history-item">
            <div class="history-info">
                <strong>Order Purchase</strong>
                <span>December 20, 2024</span>
            </div>
            <span class="points-earned">+150 pts</span>
        </div>
        <div class="history-item">
            <div class="history-info">
                <strong>Product Review</strong>
                <span>December 21, 2024</span>
            </div>
            <span class="points-earned">+50 pts</span>
        </div>
        <div class="history-item">
            <div class="history-info">
                <strong>Redeemed: 10% Off Coupon</strong>
                <span>December 18, 2024</span>
            </div>
            <span class="points-redeemed">-500 pts</span>
        </div>
    </div>
</div>

<!-- Activity Section -->
<div class="profile-section" id="activity-section">
    <div class="section-header">
        <h2>Recent Activity</h2>
    </div>

    <div class="activity-timeline" id="activityList">
        <p style="text-align: center; padding: 2rem; color: #6b7280;">Loading activities...</p>
    </div>
</div>

</div>
</div>
</div>

<footer>
    <div class="footer-content">
        <div class="footer-section">
            <h3>JBR7 BAGS</h3>
            <p>Manufacturing quality bags since day one.</p>
        </div>
        <div class="footer-section">
            <h4>Quick Links</h4>
            <ul>
                <li><span onclick="handleFooterNavigate('about')">About Us</span></li>
                <li><span onclick="handleFooterNavigate('products')">Products</span></li>
                <li><span onclick="handleFooterNavigate('contact')">Contact</span></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Contact Info</h4>
            <p>Email: roquejennylynbatac@gmail.com</p>
            <p>Phone: +639216821649</p>
        </div>
        <div class="footer-section">
            <h4>Follow Us</h4>
            <div class="social-icons">
                <span onclick="handleSocialClick('facebook')"><i class="fab fa-facebook"></i></span>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 JBR7 Bags Manufacturing. All rights reserved.</p>
    </div>
</footer>
              
    
    
    <script src="jbr7js/user-storage.js"></script>
    <script src="jbr7js/home.js"></script>
    <script src="jbr7js/profile.js"></script>
    <script src="jbr7js/notifications.js"></script>
    <script src="jbr7js/view-linker.js"></script>

    <script>
        let currentStatusFilter = 'all';
        let allOrders = [];

        // Load orders from database
        async function loadOrders(status = null) {
            const container = document.getElementById('ordersList');
            container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">Loading orders...</p>';

            try {
                const url = status ? `/jbr7php/get_orders.php?status=${status}` : '/jbr7php/get_orders.php';
                console.log('Fetching orders from:', url);
                const response = await fetch(url, { credentials: 'same-origin' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to load orders:', response.status, errorText);
                    container.innerHTML = `<p style="text-align: center; padding: 2rem; color: #dc2626;">Failed to load orders (${response.status}). Please check if you are logged in.</p>`;
                    return;
                }

                const data = await response.json();
                console.log('Orders data received:', data);
                
                if (data.success && data.orders) {
                    allOrders = data.orders;
                    if (data.orders.length === 0) {
                        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No orders found. Start shopping to see your orders here!</p>';
                    } else {
                        renderOrders(data.orders);
                    }
                } else {
                    console.warn('No orders in response:', data);
                    container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No orders found.</p>';
                }
            } catch (e) {
                console.error('Failed to load orders', e);
                container.innerHTML = `<p style="text-align: center; padding: 2rem; color: #dc2626;">Error loading orders: ${e.message}</p>`;
            }
        }

        // Render orders
        function renderOrders(orders) {
            const container = document.getElementById('ordersList');
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No orders found.</p>';
                return;
            }

            container.innerHTML = '';
            orders.forEach(order => {
                const statusClass = order.status === 'delivered' ? 'delivered' : 
                                  order.status === 'shipped' ? 'shipped' : 
                                  order.status === 'processing' ? 'processing' : '';

                const date = new Date(order.created_at).toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'long', day: 'numeric' 
                });

                // Create order wrapper for all items in this order
                const orderWrapper = document.createElement('div');
                orderWrapper.className = 'order-wrapper';
                orderWrapper.style.cssText = 'margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background: #fff;';

                // Order header (shared for all items)
                const orderHeader = document.createElement('div');
                orderHeader.className = 'order-header';
                orderHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f3f4f6;';
                orderHeader.innerHTML = `
                    <div class="order-id">
                        <strong style="font-size: 1.1rem; color: #111;">Order #${order.order_number}</strong>
                        <span class="order-date" style="display: block; color: #6b7280; font-size: 0.9rem; margin-top: 0.25rem;">${date}</span>
                        <span style="display: block; color: #6b7280; font-size: 0.85rem; margin-top: 0.25rem;">Total: ₱${parseFloat(order.total).toFixed(2)}</span>
                    </div>
                    <span class="order-status ${statusClass}" style="padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; text-transform: capitalize; 
                        ${order.status === 'delivered' ? 'background: #d1fae5; color: #065f46;' : 
                          order.status === 'shipped' ? 'background: #dbeafe; color: #1e40af;' : 
                          'background: #fef3c7; color: #92400e;'}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span>
                `;
                orderWrapper.appendChild(orderHeader);

                // Order items
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'order-items-container';
                itemsContainer.style.cssText = 'display: flex; flex-direction: column; gap: 1rem;';

                order.items.forEach((item, index) => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.style.cssText = 'display: flex; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; align-items: center;';

                    let actionsHTML = '';
                    const itemImage = item.item_image || '';
                    const itemName = item.item_name || '';
                    const itemPrice = item.item_price || 0;
                    const viewUrl = `view.html?title=${encodeURIComponent(itemName)}&price=${itemPrice}&img=${encodeURIComponent(itemImage)}&desc=${encodeURIComponent(itemName)}&from=profile`;
                    
                    if (order.status === 'delivered') {
                        actionsHTML = `
                            <a class="btn-secondary view-btn" href="${viewUrl}" style="padding: 0.5rem 1rem; margin-right: 0.5rem; text-decoration: none; display: inline-block; background: #fff; border: 2px solid #006923; color: #006923; border-radius: 6px;">View Details</a>
                            <button class="btn-primary" onclick="leaveReview(${item.id}, '${itemName.replace(/'/g, "\\'")}', '${itemImage.replace(/'/g, "\\'")}', ${itemPrice})" style="padding: 0.5rem 1rem; background: #006923; color: white; border: none; border-radius: 6px; cursor: pointer;">Leave Review</button>
                        `;
                    } else if (order.status === 'shipped') {
                        actionsHTML = `
                            <a class="btn-secondary" href="track-order.html?order_id=${order.id}&order_number=${encodeURIComponent(order.order_number)}&from=profile" style="padding: 0.5rem 1rem; margin-right: 0.5rem; text-decoration: none; display: inline-block; background: #fff; border: 2px solid #006923; color: #006923; border-radius: 6px;">
                                <i class="fas fa-map-marker-alt"></i> Track Order
                            </a>
                            <a class="btn-secondary view-btn" href="${viewUrl}" style="padding: 0.5rem 1rem; text-decoration: none; display: inline-block; background: #fff; border: 2px solid #006923; color: #006923; border-radius: 6px;">View Details</a>
                        `;
                    } else if (order.status === 'processing') {
                        actionsHTML = `
                            <a class="btn-secondary view-btn" href="${viewUrl}" style="padding: 0.5rem 1rem; margin-right: 0.5rem; text-decoration: none; display: inline-block; background: #fff; border: 2px solid #006923; color: #006923; border-radius: 6px;">View Details</a>
                            ${order.can_cancel ? `<button class="btn-danger" onclick="cancelOrder(${order.id})" style="padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel Order</button>` : ''}
                        `;
                    }

                    orderItem.innerHTML = `
                        <img src="${item.item_image || 'totebag.avif'}" alt="${item.item_name}" 
                             style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb;" 
                             onerror="this.src='totebag.avif'">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #111;">${item.item_name}</h3>
                            <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.9rem;">
                                Quantity: ${item.quantity}${item.size ? ' | Size: ' + item.size : ''}${item.color ? ' | Color: ' + item.color : ''}
                            </p>
                            <p style="margin: 0; font-size: 1.1rem; font-weight: 700; color: #006923;">₱${parseFloat(item.line_total).toFixed(2)}</p>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                            ${actionsHTML}
                        </div>
                    `;
                    itemsContainer.appendChild(orderItem);
                });

                orderWrapper.appendChild(itemsContainer);
                container.appendChild(orderWrapper);
            });
        }

        // Filter orders by status
        function filterOrders(status) {
            currentStatusFilter = status;
            
            // Update button styles
            ['All', 'Processing', 'Shipped', 'Delivered'].forEach(s => {
                const btn = document.getElementById('filter' + s);
                if (btn) {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            });
            
            const activeBtn = document.getElementById('filter' + (status === 'all' ? 'All' : status.charAt(0).toUpperCase() + status.slice(1)));
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }

            loadOrders(status === 'all' ? null : status);
        }

        // Cancel order
        async function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;

            try {
                const response = await fetch('/jbr7php/cancel_order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ order_id: orderId })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Order cancelled successfully');
                    loadOrders(currentStatusFilter === 'all' ? null : currentStatusFilter);
                } else {
                    alert(data.error || 'Failed to cancel order');
                }
            } catch (e) {
                console.error('Failed to cancel order', e);
                alert('Failed to cancel order');
            }
        }

        // Leave review - pass all necessary data to view.html
        function leaveReview(orderItemId, itemName, itemImage, itemPrice) {
            // Open view.html with product and show review form
            if (itemName) {
                const encodedTitle = encodeURIComponent(itemName);
                window.location.href = `view.html?title=${encodedTitle}&review=true`;
            } else {
                showNotification('Product information not available', 'info');
            }
        }
        
        // Old leaveReview function (keeping for compatibility)
        function leaveReviewOld(orderItemId, itemName, itemImage, itemPrice) {
            const params = new URLSearchParams({
                title: itemName,
                price: itemPrice,
                img: itemImage || '',
                desc: itemName,
                order_item_id: orderItemId,
                from: 'profile'
            });
            window.location.href = `view.html?${params.toString()}`;
        }

        // Update order status periodically
        setInterval(() => {
            fetch('/jbr7php/update_order_status.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(data => {
                    if (data.success && (data.updated.shipped > 0 || data.updated.delivered > 0)) {
                        loadOrders(currentStatusFilter === 'all' ? null : currentStatusFilter);
                    }
                })
                .catch(e => console.error('Status update failed', e));
        }, 5000); // Check every 5 seconds

        // Load user reviews
        async function loadUserReviews() {
            const reviewsList = document.getElementById('userReviewsList');
            if (!reviewsList) return;
            
            try {
                const response = await fetch('/jbr7php/get_user_reviews.php', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">Please log in to view your reviews.</p>';
                        return;
                    }
                    throw new Error('Failed to fetch reviews');
                }
                
                const data = await response.json();
                if (data.success && data.reviews) {
                    renderUserReviews(data.reviews);
                } else {
                    reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No reviews yet.</p>';
                }
            } catch (e) {
                console.error('Failed to load reviews:', e);
                reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #dc2626;">Failed to load reviews.</p>';
            }
        }

        function renderUserReviews(reviews) {
            const reviewsList = document.getElementById('userReviewsList');
            if (!reviewsList) return;
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No reviews yet.</p>';
                return;
            }
            
            reviewsList.innerHTML = '';
            reviews.forEach(review => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';
                
                // Get product details - use product_title as primary, fallback to item_title
                let productTitle = (review.product_title || review.item_title || 'Unknown Product').trim();
                let productPrice = parseFloat(review.item_price) || 0;
                let productImage = (review.item_image || 'totebag.avif').trim();
                
                // Ensure we never have "undefined" as a string
                if (productTitle === 'undefined' || productTitle === '' || !productTitle) {
                    productTitle = 'Unknown Product';
                }
                if (productImage === 'undefined' || productImage === '') {
                    productImage = 'totebag.avif';
                }
                
                // Debug logging
                if (productTitle === 'Unknown Product') {
                    console.warn('Review missing product title:', review);
                }
                if (productPrice === 0) {
                    console.log('Review price is 0 for:', productTitle, 'review data:', review);
                }
                
                // Generate stars with half-star support
                const rating = parseFloat(review.rating) || 0;
                const fullStars = Math.floor(rating);
                const hasHalfStar = (rating % 1) >= 0.5;
                let stars = '';
                for (let i = 0; i < 5; i++) {
                    if (i < fullStars) {
                        stars += '<i class="fas fa-star" style="color: #fbbf24;"></i>';
                    } else if (i === fullStars && hasHalfStar) {
                        stars += '<i class="fas fa-star-half-alt" style="color: #fbbf24;"></i>';
                    } else {
                        stars += '<i class="far fa-star" style="color: #d1d5db;"></i>';
                    }
                }
                
                // Escape HTML to prevent XSS
                const escapeHtml = (text) => {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                reviewItem.innerHTML = `
                    <div class="review-product">
                        <img src="${productImage}" alt="${escapeHtml(productTitle)}" onerror="this.src='totebag.avif'">
                        <div>
                            <h3>${escapeHtml(productTitle)}</h3>
                            <p class="review-date">Reviewed on ${review.date}</p>
                        </div>
                    </div>
                    <div class="review-rating">
                        ${stars}
                    </div>
                    <p class="review-text">"${escapeHtml(review.comment || 'No comment provided.')}"</p>
                    <div class="review-actions">
                        <a href="view.html?title=${encodeURIComponent(productTitle)}&price=${productPrice}&img=${encodeURIComponent(productImage)}&from=profile" class="btn-text">
                            <i class="fas fa-eye"></i> View Product
                        </a>
                    </div>
                `;
                reviewsList.appendChild(reviewItem);
            });
        }

        // Load user activities and points
        async function loadUserActivities() {
            try {
                const response = await fetch('/jbr7php/get_user_activities.php', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        return; // Not authenticated
                    }
                    throw new Error('Failed to fetch activities');
                }
                
                const data = await response.json();
                if (data.success) {
                    // Update points display
                    const pointsEl = document.querySelector('.loyalty-points h3');
                    if (pointsEl) {
                        pointsEl.textContent = data.points.toLocaleString();
                    }
                    
                    // Update rewards section points
                    const rewardsPointsEl = document.querySelector('.rewards-card-large h3');
                    if (rewardsPointsEl) {
                        rewardsPointsEl.textContent = data.points.toLocaleString() + ' Points';
                    }
                    
                    // Update activity history
                    renderActivities(data.activities || []);
                }
            } catch (e) {
                console.error('Failed to load activities:', e);
            }
        }

        function renderActivities(activities) {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;
            
            if (activities.length === 0) {
                activityList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No activities yet.</p>';
                return;
            }
            
            activityList.innerHTML = '';
            activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const iconClass = activity.type === 'order' ? 'added' : 
                                 activity.type === 'review' ? 'reviewed' : 'saved';
                const icon = activity.type === 'order' ? 'fa-cart-plus' :
                            activity.type === 'review' ? 'fa-star' : 'fa-heart';
                
                activityItem.innerHTML = `
                    <div class="activity-icon ${iconClass}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <strong>${activity.description || activity.type}</strong>
                        <span class="activity-time">${activity.time_ago || activity.date}</span>
                    </div>
                    <div class="activity-points">+${activity.points} pts</div>
                `;
                activityList.appendChild(activityItem);
            });
        }

        // Load orders and reviews on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
            // Reviews and activities will load when sections are shown
            // Set initial filter button
            const filterAll = document.getElementById('filterAll');
            if (filterAll) {
                filterAll.classList.remove('btn-secondary');
                filterAll.classList.add('btn-primary');
            }
        });
    </script>
    
</body>
</html>