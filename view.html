
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Product View - JBR7 Bags</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="home.css">
    <style>
        /* Scoped styles for view page */
        /* Image zoom modal */
        .img-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:12000}
        .img-modal-overlay.active{display:flex}
        .img-modal-overlay img{max-width:95%;max-height:90%;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}

        .details-container{max-width:1100px;margin:2.5rem auto;padding:1rem 3%;display:grid;grid-template-columns:1fr 1fr;gap:2rem;align-items:start}
        .product-gallery{display:flex;flex-direction:column;gap:1rem}
        .product-main-img{width:100%;height:520px;object-fit:cover;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08)}
        .thumbs{display:flex;gap:.5rem}
        .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid transparent}
        .thumbs img.active{border-color:#006923}
        .product-info h1{margin:0 0 .5rem;font-size:1.9rem}
        .product-price{color:#006923;font-weight:700;font-size:1.5rem;margin-bottom:.3rem}
        .product-quantity{color:#666;font-size:0.95rem;margin-bottom:0.8rem;font-weight:500}
        .product-desc{color:#444;line-height:1.6;margin-bottom:1rem}
        .attributes{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
        .attr{padding:.45rem .8rem;border-radius:8px;border:1px solid #e6e6e6;background:#fff}
        .attr ul li.size-option{cursor:pointer;padding:.15rem .35rem;border-radius:6px;display:list-item}
        .attr ul li.size-option:hover{background:#f0f7f2}
        .attr ul li.size-option.selected{background:#006923;color:#fff}
        .actions{display:flex;gap:1rem;margin-top:1rem}
        .btn{padding:.85rem 1.2rem;border-radius:8px;border:none;cursor:pointer;font-weight:700}
        .btn-primary{background:#006923;color:#fff}
        .btn-outline{background:#fff;border:2px solid #006923;color:#006923}
        .back-row{display:flex;align-items:center;gap:1rem;margin:1rem 3%}

        /* Reviews Section Styles */
        .reviews-section{max-width:1100px;margin:3rem auto;padding:2rem 3%;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.06);display:block !important;visibility:visible !important;}
        .reviews-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:2px solid #f0f0f0}
        .reviews-title{font-size:1.8rem;font-weight:700;color:#222}
        .rating-summary{display:flex;align-items:center;gap:2rem;padding:1.5rem;background:#f9fafb;border-radius:10px;margin-bottom:2rem}
        .overall-rating{text-align:center;padding-right:2rem;border-right:2px solid #e5e7eb}
        .overall-score{font-size:3rem;font-weight:700;color:#006923;line-height:1}
        .overall-stars{color:#fbbf24;font-size:1.2rem;margin:.5rem 0}
        .total-reviews{color:#6b7280;font-size:.9rem}
        .rating-breakdown{flex:1}
        .rating-bar{display:flex;align-items:center;gap:.8rem;margin-bottom:.6rem}
        .rating-bar-label{font-size:.9rem;color:#6b7280;min-width:60px}
        .rating-bar-container{flex:1;height:8px;background:#e5e7eb;border-radius:10px;overflow:hidden}
        .rating-bar-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:10px;transition:width .3s ease}
        .rating-bar-count{font-size:.85rem;color:#6b7280;min-width:35px;text-align:right}

        .review-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:1.5rem;margin-bottom:1.2rem;transition:box-shadow .2s ease}
        .review-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08)}
        .review-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem}
        .reviewer-info{display:flex;align-items:center;gap:.8rem}
        .reviewer-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#006923,#009c33);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem}
        .reviewer-details{display:flex;flex-direction:column}
        .reviewer-name{font-weight:600;color:#222;font-size:1rem}
        .review-date{color:#9ca3af;font-size:.85rem}
        .review-stars{color:#fbbf24;font-size:1.1rem}
        .verified-badge{display:inline-flex;align-items:center;gap:.3rem;background:#ecfdf5;color:#059669;padding:.25rem .6rem;border-radius:6px;font-size:.75rem;font-weight:600;margin-top:.3rem}
        .verified-badge i{font-size:.7rem}
        .review-content{color:#4b5563;line-height:1.7;margin-bottom:.8rem}
        .review-images{display:flex;gap:.6rem;margin-top:1rem}
        .review-img{width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;transition:transform .2s ease}
        .review-img:hover{transform:scale(1.05)}
        .helpful-section{display:flex;align-items:center;gap:1rem;margin-top:1rem;padding-top:1rem;border-top:1px solid #f3f4f6}
        .helpful-text{color:#6b7280;font-size:.9rem}
        .helpful-btn{background:#f9fafb;border:1px solid #e5e7eb;padding:.4rem 1rem;border-radius:6px;cursor:pointer;font-size:.85rem;color:#374151;transition:all .2s ease}
        .helpful-btn:hover{background:#f3f4f6;border-color:#d1d5db}
        .helpful-btn i{margin-right:.3rem;color:#006923}
        .review-form-container{background:linear-gradient(135deg,#ffffff 0%,#f9fafb 100%);border:2px solid #e5e7eb;border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:0 4px 20px rgba(0,0,0,0.05);}
        .review-form-header{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:2px solid #e5e7eb;}
        .review-form-header i{font-size:1.8rem;color:#006923;}
        .review-form-header h3{margin:0;font-size:1.5rem;font-weight:700;color:#222;}
        .review-form-group{margin-bottom:1.5rem;}
        .review-form-group label{display:block;font-weight:600;color:#374151;margin-bottom:0.75rem;font-size:0.95rem;}
        .star-rating-container{display:flex;align-items:center;gap:1.5rem;padding:1rem;background:#fff;border-radius:10px;border:1px solid #e5e7eb;}
        .star-rating{display:flex;gap:0.4rem;font-size:2rem;cursor:pointer;}
        .star-rating i{color:#d1d5db;transition:all .2s ease;}
        .star-rating i:hover,.star-rating i.active{color:#fbbf24;transform:scale(1.1);}
        .rating-text{color:#6b7280;font-size:0.95rem;font-weight:500;min-width:120px;}
        .review-textarea{width:100%;padding:1rem;border:2px solid #e5e7eb;border-radius:10px;font-family:inherit;resize:vertical;font-size:0.95rem;line-height:1.6;transition:border-color .2s ease;}
        .review-textarea:focus{outline:none;border-color:#006923;box-shadow:0 0 0 3px rgba(0,105,35,0.1);}
        .review-form-actions{display:flex;gap:1rem;margin-top:1.5rem;}
        .review-submit-btn{flex:1;padding:0.9rem 1.5rem;background:linear-gradient(135deg,#006923,#009c33);color:#fff;border:none;border-radius:10px;font-weight:600;font-size:1rem;cursor:pointer;transition:all .2s ease;box-shadow:0 4px 12px rgba(0,105,35,0.2);}
        .review-submit-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,105,35,0.3);}
        .review-cancel-btn{padding:0.9rem 1.5rem;background:#fff;border:2px solid #e5e7eb;color:#6b7280;border-radius:10px;font-weight:600;font-size:1rem;cursor:pointer;transition:all .2s ease;}
        .review-cancel-btn:hover{background:#f9fafb;border-color:#d1d5db;color:#374151;}

       

        @media(max-width:900px){
            .details-container{grid-template-columns:1fr}
            .product-main-img{height:360px}
            .rating-summary{flex-direction:column;align-items:stretch}
            .overall-rating{border-right:none;border-bottom:2px solid #e5e7eb;padding-right:0;padding-bottom:1rem}
            .reviews-header{flex-direction:column;align-items:flex-start;gap:1rem}
        }
    </style>
</head>
<body>

<header>
    <a href="home.html" class="logo">
        <img src="JBR7 BAGS LOGO.jpg" alt="JBR7 BAGS LOGO" class="logo-img" onerror="this.style.display='none'">
        <div class="logo-text">
            <h2><span>JBR7</span> BAGS</h2>
            <span class="sub-logo">MANUFACTURING</span>
        </div>
    </a>
    <div class="header-sep" aria-hidden="true"></div>
    <nav>
        <a href="home.html" onclick="handleNavigate('home'); return false;" data-page="home"><i class="fas fa-home"></i> Home</a>
        <a href="explore.html" onclick="handleNavigate('explore'); return false;" data-page="explore"><i class="fas fa-compass"></i> Explore</a>
        <a href="saved.html" onclick="handleNavigate('saved'); return false;" data-page="saved"><i class="fas fa-bookmark"></i> Saved</a>
        <a href="cart.html" onclick="handleNavigate('cart'); return false;" data-page="cart"><i class="fas fa-shopping-cart"></i> Cart</a>
        <a href="contact.html" onclick="handleNavigate('contact'); return false;" data-page="contact"><i class="fas fa-envelope"></i> Contact Us</a>
        <a href="settings.html" onclick="handleNavigate('settings'); return false;" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
        <a href="#" onclick="handleNavigate('search'); return false;" data-page="search"><i class="fas fa-search"></i></a>
        <a href="#" onclick="handleNavigate('notifications'); return false;" data-page="notifications"><i class="fas fa-bell"></i></a>
        <a href="#" onclick="handleNavigate('messages'); return false;" data-page="messages"><i class="fas fa-comment"></i></a>
        <a href="profile.html" onclick="handleNavigate('profile'); return false;" data-page="profile"><i class="fas fa-user-circle"></i></a>
    </nav>
</header>

<div class="back-row">
    <button class="btn btn-outline" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
    <div id="breadcrumb" style="color:#666;font-weight:600"></div>
</div>

<main>
    <section class="details-container">
        <div class="product-gallery">
            <img id="mainImg" class="product-main-img" src="totebag.avif" alt="Product image">
            <div class="thumbs" id="thumbs"></div>
        </div>
        <div class="product-info">
            <h1 id="productTitle">Product Title</h1>
            <div class="product-price" id="productPrice">₱0.00</div>
            <div class="product-quantity" id="productQuantity">Quantity: 0</div>
            <div class="product-desc" id="productDesc">Product description will appear here. This area contains materials, dimensions and care instructions.</div>

            <div class="attributes" id="attributes"></div>

            <div class="actions">
                <button class="btn btn-primary" id="addToCart">Add to cart</button>
                <button class="btn btn-outline" id="saveItem">Save</button>
            </div>
        </div>
    </section>

    

        <!-- Review Form (shown for authenticated users) -->
        <div class="review-form-container" id="reviewFormContainer" style="display:none;">
            <div class="review-form-header">
                <i class="fas fa-star"></i>
                <h3>Share Your Experience</h3>
            </div>
            <form id="reviewForm">
                <div class="review-form-group">
                    <label>Your Rating</label>
                    <div class="star-rating-container">
                        <div class="star-rating" id="starRating">
                            <i class="far fa-star" data-rating="1"></i>
                            <i class="far fa-star" data-rating="2"></i>
                            <i class="far fa-star" data-rating="3"></i>
                            <i class="far fa-star" data-rating="4"></i>
                            <i class="far fa-star" data-rating="5"></i>
                        </div>
                        <span id="ratingText" class="rating-text">Select a rating</span>
                    </div>
                </div>
                <input type="hidden" id="reviewRating" name="rating" value="0" step="0.5" required>
                <div class="review-form-group">
                    <label for="reviewContent">Your Review</label>
                    <textarea id="reviewContent" name="content" rows="6" class="review-textarea"
                        placeholder="Tell us about your experience with this product. What did you like? What could be improved?" required></textarea>
                </div>
                <div class="review-form-actions">
                    <button type="submit" class="review-submit-btn">
                        <i class="fas fa-paper-plane" style="margin-right:0.5rem;"></i>Submit Review
                    </button>
                    <button type="button" class="review-cancel-btn" onclick="cancelReview()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <div class="reviews-header">
                <h2 class="reviews-title">Customer Reviews</h2>
            </div>
            
            <!-- Rating Summary -->
            <div class="rating-summary">
                <div class="overall-rating">
                    <div class="overall-score" id="overallScore">0.0</div>
                    <div class="overall-stars" id="overallStars"></div>
                    <div class="total-reviews" id="totalReviews">Based on 0 reviews</div>
                </div>
                <div class="rating-breakdown">
                    <div class="rating-bar">
                        <span class="rating-bar-label">5 stars</span>
                        <div class="rating-bar-container">
                            <div class="rating-bar-fill" style="width:0%"></div>
                        </div>
                        <span class="rating-bar-count">0</span>
                    </div>
                    <div class="rating-bar">
                        <span class="rating-bar-label">4 stars</span>
                        <div class="rating-bar-container">
                            <div class="rating-bar-fill" style="width:0%"></div>
                        </div>
                        <span class="rating-bar-count">0</span>
                    </div>
                    <div class="rating-bar">
                        <span class="rating-bar-label">3 stars</span>
                        <div class="rating-bar-container">
                            <div class="rating-bar-fill" style="width:0%"></div>
                        </div>
                        <span class="rating-bar-count">0</span>
                    </div>
                    <div class="rating-bar">
                        <span class="rating-bar-label">2 stars</span>
                        <div class="rating-bar-container">
                            <div class="rating-bar-fill" style="width:0%"></div>
                        </div>
                        <span class="rating-bar-count">0</span>
                    </div>
                    <div class="rating-bar">
                        <span class="rating-bar-label">1 star</span>
                        <div class="rating-bar-container">
                            <div class="rating-bar-fill" style="width:0%"></div>
                        </div>
                        <span class="rating-bar-count">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Reviews List -->
            <div id="reviewsList"></div>
        </div>
</main>

<!-- Image modal for zoom -->
<div id="imgModal" class="img-modal-overlay" aria-hidden="true" role="dialog" onclick="closeImageModal()">
    <img id="imgModalImg" src="" alt="Zoomed image">
</div>

<footer style="margin-top:3rem;padding:2rem 3%;background:#f7f7f7;text-align:center;color:#666">
    &copy; 2025 JBR7 Bags Manufacturing
</footer>

<script src="jbr7js/user-storage.js"></script>
<script src="jbr7js/home.js"></script>
<script src="jbr7js/notifications.js"></script>
<script>
    // Global API helper so loadProductReviews and other async code can use it (assign to window for async callbacks)
    function apiFetch(url, options) {
        const opts = options || {};
        const headers = opts.headers ? { ...opts.headers } : {};
        const uid = sessionStorage.getItem('jbr7_user_id');
        if (uid) headers['X-User-Id'] = uid;
        return fetch(url, { ...opts, headers });
    }
    window.apiFetch = apiFetch;

    // Image folders that exist in the repo (Vercel serves from root). Paths outside this list use totebag.avif to avoid 404s.
    const EXISTING_IMAGE_FOLDERS = ['Tote Bag', 'Riki Bag', 'Mirror Bag', 'Module', 'One', 'Two Color', 'RingLight', 'Katrina Plain', 'Katrina Two Colors', 'JBR7 COURIER IMAGE', 'JBR7 PMETHOD IMAGE'];
    function imagePathOrFallback(path) {
        if (!path || path === 'totebag.avif' || path.startsWith('http') || path.startsWith('data:')) return path;
        const folder = path.indexOf('/') >= 0 ? path.split('/')[0] : '';
        return folder && EXISTING_IMAGE_FOLDERS.indexOf(folder) === -1 ? 'totebag.avif' : path;
    }
    // Demo PRODUCTS array with quantities
const PRODUCTS = [
        { id: '1', slug: 'eco-jute-tote', title: 'Eco Jute Tote Bag', price: 45.00, quantity: 104, imgs: ['Tote Bag/Black.png', 'Tote Bag/Sizes.jpg', 'Tote Bag/Colored.png', 'Tote Bag/White.png'], desc: 'Sustainable jute tote with scallop top design, perfect for everyday use. Size: 40x35cm.', attrs: ['Eco-friendly', 'Cotton straps', 'Machine wash cold'], sizes: [{label:'8x10',price:35},{label:'10x12',price:45},{label:'13x15',price:50},{label:'14x16',price:55}] },
        { id: '2', slug: 'module-backpack', title: 'Professional Module Backpack', price: 78.00, quantity: 87, imgs: ['https://www.teqler.com/media/_processed_/6/8/csm_T131370_70518ba90d.jpg'], desc: 'Multi-compartment backpack with laptop sleeve and water-resistant fabric.', attrs: ['Laptop sleeve', 'Water-resistant', 'Multiple pockets'] },
        { id: '3', slug: 'canvas-messenger', title: 'Canvas Messenger Bag', price: 62.00, quantity: 52, imgs: ['https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=500'], desc: 'Classic canvas messenger with adjustable strap and multiple pockets.', attrs: ['Adjustable strap', 'Canvas material', 'One main compartment'] },
        { id: '4', slug: 'riki-bag', title: 'Riki Bag', price: 38.00, quantity: 143, imgs: ['Riki Bag/Riki.jpg','Riki Bag/View1.jpg','Riki Bag/View2.jpg','Riki Bag/View3.jpg'], desc: 'Minimalist Riki bag with clean lines and durable material.', attrs: ['Minimalist', 'Durable', 'Lightweight'] },
        { id: '5', slug: 'ringlight-bag', title: 'Ringlight Bag', price: 500.00, quantity: 28, imgs: ['RingLight/Ringlight.jpg','RingLight/View1.jpg','RingLight/View2.jpg','RingLight/View3.png','RingLight/View4.jpg'], desc: 'Protective bag designed to fit ring lights. Choose the size for 45cm or 55cm ring lights.', attrs: ['Padded interior','Zipper closure'], sizes: [{label:'18x21',price:500},{label:'22x22',price:550}] },
        { id: '6', slug: 'vanity-mirror-bag', title: 'Vanity Mirror Bag', price: 400.00, quantity: 67, imgs: ['Mirror Bag/68ba1e35671d997f6eb3ed1c376a4b27.jpg','Mirror Bag/c478589e0dd22f83b034d6bbf99f5489.jpg'], desc: 'Padded bag for vanity mirrors. Select size for correct pricing.', attrs: ['Soft lining','Zipper closure'], sizes: [{label:'14x14',price:400},{label:'14x16',price:430},{label:'16x19',price:450},{label:'16x21',price:470},{label:'17x25',price:500},{label:'20x24',price:550},{label:'21x28',price:650}] },
        { id: '7', slug: 'eco-colored-tote', title: 'Eco Colored Tote Bag', price: 55.00, quantity: 95, imgs: ['Tote Bag/Colored.png','Tote Bag/Sizes.jpg','Tote Bag/Black.png','Tote Bag/White.png'], desc: 'Tote Bag Katsa White, Black and Colored — lightweight, durable, and perfect for everyday use.', attrs: ['Eco-friendly', 'Cotton straps', 'Machine wash cold'] },
        { id: '8', slug: 'riki-tall-bag', title: 'Riki Tall Bag', price: 850.00, quantity: 61, imgs: ['Riki Bag/Riki.jpg','Riki Bag/View1.jpg','Riki Bag/View2.jpg','Riki Bag/View3.jpg'], desc: 'Size: 29x22 x 1.5 inches', attrs: ['Premium quality', 'Durable', 'Spacious'] },
        { id: '9', slug: 'plain-brass-backpack', title: 'Plain Brass Cotton Back Pack', price: 180.00, quantity: 119, imgs: ['One/ph-11134207-7ras8-m9txs8bfjp3gc0.jpg','One/ph-11134207-7ras8-m9txs9pdilz812.jpg','One/ph-11134207-7rasa-m9txs9cc1ozocf.jpg','One/ph-11134207-7rasb-m9txs904kypwb9.jpg','One/ph-11134207-7rase-m9txs91sh4g4fa.jpg','One/ph-11134207-7rasj-m9txs9867s9824.jpg','One/ph-11134207-7rasj-m9txs9bs2i8c8e.jpg'], desc: 'Size: 16.5 x 12 x 4.5 inches Fabric Used: Brass Cotton', attrs: ['Durable', 'Multiple compartments', 'Brass cotton'] },
        { id: '10', slug: 'two-colored-backpack', title: 'Two Colored Brass Cotton Back Pack', price: 180.00, quantity: 78, imgs: ['Two Color/ph-11134207-7rasg-m9ty0a4dge0z1e.jpg','Two Color/ph-11134207-7ras9-m9txs8a1rcgcdf.jpg','Two Color/ph-11134207-7ras9-m9txs8a23zk465.jpg','Two Color/ph-11134207-7rasa-m9txs90oiqx00c.jpg','Two Color/ph-11134207-7rasc-m9txs8a1lq6k26.jpg','Two Color/ph-11134207-7rasd-m9txs8a1n4r03f.jpg','Two Color/ph-11134207-7rasd-m9txs8a22kzo9a.jpg','Two Color/ph-11134207-7rask-m9txs8a216f850.jpg','Two Color/ph-11134207-7rasm-m9txs8a1ojbg7a.jpg'], desc: 'Size: 16.5 x 12 x 4.5 inches Fabric Used: Brass Cotton', attrs: ['Eco-Friendly', 'Brass cotton', 'Two-tone design'] },
        { id: '11', slug: 'envelope-bag', title: 'Envelope Bags', price: 70.00, quantity: 82, imgs: ['totebag.avif'], desc: 'Size 15*12.5inches', attrs: ['Lightweight', 'Secure closure', 'Multiple colors'] },
        { id: '12', slug: 'boys-kiddie-bag', title: 'Boys Kiddie Bag', price: 140.00, quantity: 134, imgs: ['totebag.avif'], desc: 'Sizes: S, M, L', attrs: ['Kid-friendly', 'Durable', 'Fun designs'] },
        { id: '13', slug: 'girls-kiddie-bag', title: 'Girls Kiddie Bag', price: 140.00, quantity: 91, imgs: ['totebag.avif'], desc: 'Sizes: S, M, L', attrs: ['Kid-friendly', 'Durable', 'Fun designs'] },
        { id: '14', slug: 'katrina-plain', title: 'Katrina Plain', price: 180.00, quantity: 73, imgs: ['Katrina Plain/Copy of Green Grey Simple Modern New Arrival Instagram Post (1).png','Katrina Plain/Copy of Green Grey Simple Modern New Arrival Instagram Post (2).png','Katrina Plain/Copy of Green Grey Simple Modern New Arrival Instagram Post (3).png','Katrina Plain/Copy of Green Grey Simple Modern New Arrival Instagram Post (4).png','Katrina Plain/Copy of Green Grey Simple Modern New Arrival Instagram Post (5).png','Katrina Plain/Copy of Green Grey Simple Modern New Arrival Instagram Post (6).png','Katrina Plain/Copy of Green Grey Simple Modern New Arrival Instagram Post.png','Katrina Plain/Copy of Turquoise brown explore Turkey framed tourism photo collage .png'], desc: 'Size: 16.5 x 12 x 4.5 inches Fabric Used: Brass Cotton', attrs: ['Brass cotton', 'Plain design', 'Versatile'] },
        { id: '15', slug: 'katrina-two-colors', title: 'Katrina Two Colors', price: 180.00, quantity: 108, imgs: ['Katrina Two Colors/1.png','Katrina Two Colors/2.png','Katrina Two Colors/3.png','Katrina Two Colors/4.png','Katrina Two Colors/5.png','Katrina Two Colors/6.png','Katrina Two Colors/7.png','Katrina Two Colors/8.png'], desc: 'Size: 16.5 x 12 x 4.5 inches Fabric Used: Brass Cotton', attrs: ['Brass cotton', 'Two-tone', 'Stylish'] },
        { id: '16', slug: 'module-bag', title: 'Module Bag', price: 90.00, quantity: 126, imgs: ['Module/ph-11134207-7r98r-lxmbqd55abtt7c.avif','Module/ph-11134207-7r98s-lxmbqd553azl8a.avif','Module/ph-11134207-7r98v-lxmbqd558x9d1f.avif','Module/ph-11134207-7r98y-lxmbqd55d4yp9e.avif','Module/ph-11134207-7r98z-lxmbqd557iox98.avif','Module/ph-11134207-7r991-lxmbqd55644h4a.avif','Module/ph-11134207-7r991-lxmbqd55bqe93b.avif','Module/ph-11134207-7rase-m0s7s6efed5085.avif'], desc: 'Size 15*12.5*3.5 inches Fabric Used: Poly Rubber and PVC Transparent', attrs: ['Transparent design', 'Poly rubber', 'Functional'] }
    ];

    // Dummy reviews data
    // Reviews will be loaded from database
let REVIEWS = [];

    function qParam(name){
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }

    function formatPrice(n){ return '₱' + Number(n).toFixed(2); }

    function generateStars(rating){
        let stars = '';
        const full = Math.floor(rating);
        const hasHalf = rating % 1 >= 0.5;
        
        for(let i = 0; i < full; i++){
            stars += '<i class="fas fa-star"></i>';
        }
        if(hasHalf){
            stars += '<i class="fas fa-star-half-alt"></i>';
        }
        const empty = 5 - full - (hasHalf ? 1 : 0);
        for(let i = 0; i < empty; i++){
            stars += '<i class="far fa-star"></i>';
        }
        return stars;
    }

   function renderReviews(){
        const container = document.getElementById('reviewsList');
        if (!container) {
            console.error('Reviews container not found!');
            return;
        }
        container.innerHTML = '';
        
        console.log('Rendering reviews, count:', REVIEWS.length);
        console.log('Reviews data:', REVIEWS);
        
        // Get current product image for display in reviews
        // Use the actual loaded image from the mainImg element (browser resolves paths)
        const mainImgEl = document.getElementById('mainImg');
        let productImage = '/totebag.avif'; // Default fallback with leading slash
        
        if (mainImgEl) {
            if (mainImgEl.src) {
                // Use the actual src (browser has already resolved it to full URL or relative path)
                productImage = mainImgEl.src;
                console.log('Using mainImg src for review:', productImage);
            } else if (mainImgEl.getAttribute('src')) {
                // Fallback to attribute
                productImage = mainImgEl.getAttribute('src');
                console.log('Using mainImg attribute for review:', productImage);
            }
        }
        
        // Fallback to product object if mainImg doesn't have src
        if ((!productImage || productImage === '/totebag.avif' || productImage === 'totebag.avif') && window.currentProduct && window.currentProduct.imgs && window.currentProduct.imgs.length > 0) {
            productImage = window.currentProduct.imgs[0];
            console.log('Using product.imgs[0] for review:', productImage);
            // Ensure it's a valid path - add leading slash if needed
            if (productImage && !productImage.startsWith('http') && !productImage.startsWith('//') && !productImage.startsWith('/') && !productImage.startsWith('data:')) {
                productImage = '/' + productImage;
            }
        }
        
        console.log('Final productImage for reviews:', productImage);
        
        if(REVIEWS.length === 0){
            container.innerHTML = '<p style="text-align:center;padding:2rem;color:#6b7280;">No reviews yet. Be the first to review this product!</p>';
            return;
        }
        
        REVIEWS.forEach((review, index) => {
            console.log(`Review ${index}:`, review);
            console.log(`Review ${index} content:`, review.content);
            
            const card = document.createElement('div');
            card.className = 'review-card';
            
            // Escape HTML to prevent XSS, but preserve line breaks
            const escapeHtml = (text) => {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // Get review content - check ALL possible fields
            let reviewContent = '';
            
            // Priority: content > body > comment > title
            if (review.content && typeof review.content === 'string' && review.content.trim() !== '') {
                reviewContent = review.content.trim();
            } else if (review.body && typeof review.body === 'string' && review.body.trim() !== '') {
                reviewContent = review.body.trim();
            } else if (review.comment && typeof review.comment === 'string' && review.comment.trim() !== '') {
                reviewContent = review.comment.trim();
            } else if (review.title && typeof review.title === 'string' && review.title.trim() !== '') {
                reviewContent = review.title.trim();
            }
            
            // If still empty, use default
            if (!reviewContent || reviewContent === '') {
                reviewContent = 'No comment provided';
            }
            
            // Escape HTML but preserve line breaks
            const safeContent = escapeHtml(reviewContent).replace(/\n/g, '<br>');
            
            card.innerHTML = `
                <div class="review-header">
                    <div class="reviewer-info">
                        <div class="reviewer-avatar">${review.initials || 'AN'}</div>
                        <div class="reviewer-details">
                            <div class="reviewer-name" style="font-weight: 600; color: #222; font-size: 1rem; margin-bottom: 0.25rem;">${review.name || 'Anonymous'}</div>
                            <div class="review-date" style="font-size: 0.85rem; color: #9ca3af;">${review.date || 'Recently'}</div>
                            ${review.verified ? '<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified Purchase</span>' : ''}
                        </div>
                    </div>
                    <div class="review-stars" style="color: #fbbf24; font-size: 1.1rem;">${generateStars(review.rating || 0)}</div>
                </div>
                <div class="review-content" style="min-height: 20px; padding: 0.75rem 0; color: #4b5563; line-height: 1.7; font-size: 0.95rem;">${safeContent}</div>
                <div class="review-images" style="display: flex; gap: 0.6rem; margin-top: 1rem; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <img src="${productImage}" alt="Product" class="review-img" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid #e5e7eb;" onerror="this.onerror=null; this.src='/totebag.avif';" onload="console.log('Review image loaded:', this.src);" onclick="openReviewImageModal(this)">
                        <span style="font-size: 0.85rem; color: #6b7280; font-weight: 500;">Product Image</span>
                    </div>
                </div>
                <div class="helpful-section">
                    <span class="helpful-text">Was this helpful?</span>
                    <button class="helpful-btn" onclick="markHelpful(this)">
                        <i class="far fa-thumbs-up"></i> Yes (${review.helpful || 0})
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    function openImageModal(imgSrc) {
        const modal = document.getElementById('imgModal');
        const modalImg = document.getElementById('imgModalImg');
        if (modal && modalImg) {
            // Handle both relative and absolute paths
            let finalSrc = imgSrc;
            if (!finalSrc.startsWith('http') && !finalSrc.startsWith('//')) {
                if (!finalSrc.startsWith('/')) {
                    finalSrc = '/' + finalSrc;
                }
            }
            modalImg.src = finalSrc;
            modalImg.onerror = function() {
                this.src = '/totebag.avif';
            };
            modal.classList.add('active');
        }
    }
    
    function openReviewImageModal(imgElement) {
        // Handle review image modal - use the actual loaded image src
        const modal = document.getElementById('imgModal');
        const modalImg = document.getElementById('imgModalImg');
        if (modal && modalImg && imgElement) {
            // Use the actual src from the image element (already loaded and resolved by browser)
            const imgSrc = imgElement.src || imgElement.getAttribute('src') || 'totebag.avif';
            modalImg.src = imgSrc;
            modalImg.onerror = function() {
                this.src = 'totebag.avif';
            };
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
    }
    
    function closeImageModal() {
        const modal = document.getElementById('imgModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function markHelpful(btn){
        const icon = btn.querySelector('i');
        if(icon.classList.contains('far')){
            icon.classList.remove('far');
            icon.classList.add('fas');
            btn.style.background = '#ecfdf5';
            btn.style.borderColor = '#059669';
            btn.style.color = '#059669';
            const match = btn.textContent.match(/\d+/);
            if(match){
                const num = parseInt(match[0]) + 1;
                btn.innerHTML = `<i class="fas fa-thumbs-up"></i> Yes (${num})`;
            }
        }
    }
    // Star rating interaction with half-star support
    function initStarRating(){
        const stars = document.querySelectorAll('#starRating i');
        const ratingInput = document.getElementById('reviewRating');
        const ratingText = document.getElementById('ratingText');
        let currentRating = 0;
        
        // Remove any existing event listeners by cloning nodes
        stars.forEach(star => {
            const newStar = star.cloneNode(true);
            star.parentNode.replaceChild(newStar, star);
        });
        
        const newStars = document.querySelectorAll('#starRating i');
        
        newStars.forEach((star, index) => {
            // Click on star - left half = half star, right half = full star
            star.addEventListener('click', (e) => {
                e.stopPropagation();
                const rect = star.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const isLeftHalf = x < rect.width / 2;
                const rating = index + (isLeftHalf ? 0.5 : 1);
                currentRating = rating;
                ratingInput.value = rating;
                updateStarDisplay(newStars, rating, ratingText);
            });
            
            // Hover on left half = half star, right half = full star
            star.addEventListener('mousemove', (e) => {
                const rect = star.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const isLeftHalf = x < rect.width / 2;
                const hoverRating = index + (isLeftHalf ? 0.5 : 1);
                previewStarDisplay(newStars, hoverRating);
            });
            
            star.addEventListener('mouseleave', () => {
                updateStarDisplay(newStars, currentRating, ratingText);
            });
        });
        
        function updateStarDisplay(stars, rating, ratingText) {
            const full = Math.floor(rating);
            const hasHalf = rating % 1 >= 0.5;
            
            stars.forEach((s, i) => {
                s.classList.remove('fas', 'far', 'fa-star', 'fa-star-half-alt', 'active');
                if (i < full) {
                    s.classList.add('fas', 'fa-star', 'active');
                } else if (i === full && hasHalf) {
                    s.classList.add('fas', 'fa-star-half-alt', 'active');
                } else {
                    s.classList.add('far', 'fa-star');
                }
            });
            
            if (rating > 0) {
                const labels = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                const labelIndex = Math.ceil(rating) - 1;
                ratingText.textContent = rating % 1 === 0.5 ? `${labels[labelIndex]} (${rating})` : labels[labelIndex];
            } else {
                ratingText.textContent = 'Select a rating';
            }
        }
        
        function previewStarDisplay(stars, rating) {
            const full = Math.floor(rating);
            const hasHalf = rating % 1 >= 0.5;
            
            stars.forEach((s, i) => {
                s.classList.remove('fas', 'far', 'fa-star', 'fa-star-half-alt', 'active');
                if (i < full) {
                    s.classList.add('fas', 'fa-star');
                } else if (i === full && hasHalf) {
                    s.classList.add('fas', 'fa-star-half-alt');
                } else {
                    s.classList.add('far', 'fa-star');
                }
            });
        }
    }

    // Submit review
    async function submitReview(e){
        e.preventDefault();
        
        const rating = document.getElementById('reviewRating').value;
        const content = document.getElementById('reviewContent').value.trim();
        
        if(!rating || rating == 0 || rating < 0.5){
            alert('Please select a rating (minimum 0.5 stars)');
            return;
        }
        if(!content){
            alert('Please write a review');
            return;
        }
        
        const productTitle = document.getElementById('productTitle').textContent.trim();
        console.log('Submitting review for product:', productTitle);
        const productPrice = document.getElementById('productPrice').textContent.replace('₱', '').trim();
        const mainImg = document.getElementById('mainImg');
        // Get relative path from src, handling both absolute and relative URLs
        let productImage = mainImg ? mainImg.src : '';
        // Convert absolute URL to relative path if needed
        if (productImage && productImage.includes(window.location.origin)) {
            productImage = productImage.replace(window.location.origin, '');
        }
        // Remove leading slash if present
        if (productImage && productImage.startsWith('/')) {
            productImage = productImage.substring(1);
        }
        const orderItemId = qParam('order_item_id');
        
        try {
            // Parse rating - allow decimals for half stars
            const ratingValue = parseFloat(rating);
            if (isNaN(ratingValue) || ratingValue < 0.5 || ratingValue > 5) {
                alert('Please select a valid rating (0.5 to 5 stars)');
                return;
            }
            
            const submitFetch = typeof window.apiFetch === 'function' ? window.apiFetch : fetch;
            const response = await submitFetch('/api/submit_review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_title: productTitle,
                    rating: ratingValue,
                    content: content
                })
            });
            
            const data = await response.json();
            
            if(data.success){
                if(typeof showNotification === 'function'){
                    showNotification('Review submitted successfully!', 'success');
                } else {
                    alert('Review submitted successfully!');
                }
                document.getElementById('reviewFormContainer').style.display = 'none';
                document.getElementById('reviewForm').reset();
                document.querySelectorAll('#starRating i').forEach(s => {
                    s.classList.remove('fas', 'active');
                    s.classList.add('far');
                });
                document.getElementById('ratingText').textContent = '';
                document.getElementById('reviewRating').value = '0';
                
                // Reload reviews after a short delay to ensure database is updated
                setTimeout(async () => {
                    await loadProductReviews(productTitle);
                    // Scroll to reviews section after loading
                    const reviewsSection = document.querySelector('.reviews-section');
                    if (reviewsSection) {
                        reviewsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 500);
            } else {
                alert(data.error || 'Failed to submit review');
            }
        } catch(e){
            console.error('Submit review error:', e);
            alert('Failed to submit review. Please try again.');
        }
    }

    function cancelReview(){
        document.getElementById('reviewFormContainer').style.display = 'none';
        document.getElementById('reviewForm').reset();
        document.querySelectorAll('#starRating i').forEach(s => {
            s.classList.remove('fas', 'active');
            s.classList.add('far');
        });
        document.getElementById('ratingText').textContent = '';
    }

    // Load reviews from database (single fetch per product to avoid duplicate 404s)
    var _reviewsLoadKey = '';
    async function loadProductReviews(productTitle){
    try {
        const normalizedTitle = (productTitle || '').trim();
        if (!normalizedTitle) return;
        if (_reviewsLoadKey === normalizedTitle) return;
        _reviewsLoadKey = normalizedTitle;
        console.log('Loading reviews for product:', normalizedTitle);

        const fetchFn = typeof window.apiFetch === 'function' ? window.apiFetch : fetch;
        const response = await fetchFn('/api/get_product_reviews?product=' + encodeURIComponent(normalizedTitle), {
            credentials: 'same-origin'
        });
        
        console.log('Review fetch response status:', response.status);
        console.log('Review fetch URL:', '/api/get_product_reviews?product=' + encodeURIComponent(normalizedTitle));
        
        if(!response.ok) {
            console.error('Response not OK:', response.status);
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error('Failed to load reviews');
        }
        
        const data = await response.json();
        console.log('Reviews data received:', data);
        console.log('Number of reviews:', data.reviews ? data.reviews.length : 0);
        
        if(data.success && data.reviews){
            REVIEWS = data.reviews;
            // Log each review's content for debugging
            REVIEWS.forEach((review, idx) => {
                console.log(`Review ${idx} FULL OBJECT:`, review);
                console.log(`Review ${idx} content check:`, {
                    content: review.content,
                    body: review.body,
                    comment: review.comment,
                    hasContent: !!review.content,
                    contentLength: review.content ? review.content.length : 0,
                    contentType: typeof review.content
                });
            });
            updateRatingSummary(data.summary);
            renderReviews();
        } else {
            console.log('No reviews found or error:', data);
            REVIEWS = [];
            updateRatingSummary({ total: 0, average: 0, breakdown: {5:0, 4:0, 3:0, 2:0, 1:0} });
            renderReviews();
        }
    } catch(e){
        console.error('Load reviews error:', e);
        REVIEWS = [];
        updateRatingSummary({ total: 0, average: 0, breakdown: {5:0, 4:0, 3:0, 2:0, 1:0} });
        renderReviews();
    } finally {
        _reviewsLoadKey = '';
    }
}

    // Update rating summary based on real data
    // Update rating summary based on real data
function updateRatingSummary(summary){
    if(!summary) {
        summary = {
            total: 0,
            average: 0,
            breakdown: {5:0, 4:0, 3:0, 2:0, 1:0}
        };
    }
    
    const average = summary.average || 0;
    const total = summary.total || 0;
    
    document.getElementById('overallScore').textContent = average.toFixed(1);
    document.getElementById('overallStars').innerHTML = generateStars(average);
    document.getElementById('totalReviews').textContent = `Based on ${total} review${total !== 1 ? 's' : ''}`;
    
    const breakdown = summary.breakdown || {5:0, 4:0, 3:0, 2:0, 1:0};
    
    const bars = document.querySelectorAll('.rating-bar');
    [5, 4, 3, 2, 1].forEach((star, index) => {
        const count = breakdown[star] || 0;
        const percentage = total > 0 ? (count / total * 100) : 0;
        const bar = bars[index];
        if(bar){
            const fill = bar.querySelector('.rating-bar-fill');
            const countEl = bar.querySelector('.rating-bar-count');
            if(fill) fill.style.width = percentage + '%';
            if(countEl) countEl.textContent = count;
        }
    });
}

    function populate(product){
        if(!product) return;
        // Store product globally for reviews to access
        window.currentProduct = product;
        
        document.getElementById('productTitle').textContent = product.title;
        // Ensure price is set correctly - use product price or default to first size price if available
        let displayPrice = product.price || 0;
        if (displayPrice === 0 && product.sizes && product.sizes.length > 0) {
            // If price is 0, try to get from first size
            const firstSize = product.sizes[0];
            if (firstSize && typeof firstSize.price !== 'undefined') {
                displayPrice = firstSize.price;
            }
        }
        document.getElementById('productPrice').textContent = formatPrice(displayPrice);
        document.getElementById('productQuantity').textContent = 'Quantity: ' + (product.quantity || 100);
        document.getElementById('productDesc').textContent = product.desc;
        const main = document.getElementById('mainImg');
        const effectiveImgs = (product.imgs && product.imgs.length ? product.imgs : ['totebag.avif']).map(imagePathOrFallback);
        const firstImg = effectiveImgs[0] || 'totebag.avif';
        // Use relative path so it works from any base URL (Vercel, local, subpath)
        let imgPath = firstImg;
        if (!imgPath.startsWith('http') && !imgPath.startsWith('//') && !imgPath.startsWith('data:')) {
            if (!imgPath.startsWith('/')) imgPath = imgPath; // keep relative
        }
        main.src = imgPath;
        const fallbackImg = 'totebag.avif';
        main.onerror = function() {
            this.onerror = null;
            this.src = fallbackImg;
        };
        // Wait for image to load before rendering reviews
        main.onload = function() {
            console.log('Product image loaded:', this.src);
        };

        const titleLower = (product.title || '').toLowerCase();
        if ((titleLower.includes('eco jute') || titleLower.includes('tote')) ) {
            if (!product.imgs.includes('Tote Bag/Sizes.jpg')) {
                product.imgs.splice(1, 0, 'Tote Bag/Sizes.jpg');
            }
        }

        const thumbs = document.getElementById('thumbs');
        thumbs.innerHTML = '';
        const thumbFallback = 'totebag.avif';
        effectiveImgs.forEach((src, i) => {
            const img = document.createElement('img');
            img.src = src;
            img.onerror = function(){ this.onerror=null; this.src=thumbFallback; };
            if(i===0) img.classList.add('active');
            img.addEventListener('click', () => {
                document.querySelectorAll('.thumbs img').forEach(t=>t.classList.remove('active'));
                img.classList.add('active');
                main.src = src;
            });
            thumbs.appendChild(img);
        });
        
        (function probeProductFolderForViews(){
            try {
                const first = product.imgs[0] || '';
                if (!first || !first.includes('/')) return;

                const folderName = first.split('/')[0];
                const thumbs = document.getElementById('thumbs');
                const main = document.getElementById('mainImg');

                const fallbackThumb = 'totebag.avif';
                const addThumb = (path, insertAtSecondForSizes=false) => {
                    if (product.imgs.includes(path)) return;
                    if (insertAtSecondForSizes) {
                        product.imgs.splice(1, 0, path);
                        const timg = document.createElement('img'); timg.src = path;
                        timg.onerror = function(){ this.onerror=null; this.src=fallbackThumb; };
                        timg.addEventListener('click', () => { document.querySelectorAll('.thumbs img').forEach(t=>t.classList.remove('active')); timg.classList.add('active'); main.src = path; });
                        const firstThumb = thumbs.querySelector('img');
                        if (firstThumb && firstThumb.nextSibling) thumbs.insertBefore(timg, firstThumb.nextSibling); else thumbs.appendChild(timg);
                    } else {
                        product.imgs.push(path);
                        const timg = document.createElement('img'); timg.src = path;
                        timg.onerror = function(){ this.onerror=null; this.src=fallbackThumb; };
                        timg.addEventListener('click', () => { document.querySelectorAll('.thumbs img').forEach(t=>t.classList.remove('active')); timg.classList.add('active'); main.src = path; });
                        thumbs.appendChild(timg);
                    }
                };

                // Try root first (Vercel), then JBR7 JSON folder (local / deployments that keep structure)
                function loadManifest() {
                    const urls = ['image-manifest.json', 'JBR7 JSON/image-manifest.json'];
                    let i = 0;
                    function tryNext() {
                        if (i >= urls.length) { runCandidateProbe(folderName); return; }
                        fetch(urls[i], {cache: 'no-store'}).then(r => {
                            if (!r.ok) throw new Error('no-manifest');
                            return r.json();
                        }).then(manifest => {
                            const entries = manifest[folderName];
                            if (Array.isArray(entries) && entries.length) {
                                entries.forEach(name => {
                                    const path = folderName + '/' + name;
                                    if (name.toLowerCase() === 'sizes.jpg') addThumb(path, true);
                                    else addThumb(path, false);
                                });
                                return;
                            }
                            runCandidateProbe(folderName);
                        }).catch(() => { i++; tryNext(); });
                    }
                    tryNext();
                }
                loadManifest();

                function runCandidateProbe(folderName){
                    const folder = folderName;
                    const candidates = [
                        'Sizes.jpg',
                        'view1.jpg','view2.jpg','view3.jpg','view4.jpg','view5.jpg','view6.jpg',
                        'View1.jpg','View2.jpg','View3.jpg','View4.jpg','View5.jpg','View6.jpg',
                        'view1.png','view2.png','view3.png','view4.png','view5.png','view6.png',
                        'View1.png','View2.png','View3.png','View4.png','View5.png','View6.png',
                        '1.jpg','2.jpg','3.jpg','4.jpg','5.jpg','6.jpg',
                        '1.png','2.png','3.png','4.png','5.png','6.png',
                        'Black.png','Colored.png','White.png','blue.png','red.png','Blue.png','Red.png'
                    ];

                    const imageExists = (url) => new Promise(resolve => {
                        const img = new Image(); img.onload = () => resolve(true); img.onerror = () => resolve(false); img.src = url;
                    });

                    (async function run(){
                        for (const candidate of candidates) {
                            const path = folder + '/' + candidate;
                            if (product.imgs.includes(path)) continue;
                            const exists = await imageExists(path);
                            if (exists) {
                                if (candidate.toLowerCase() === 'sizes.jpg') addThumb(path, true);
                                else addThumb(path, false);
                            }
                        }
                    })();
                }

            } catch (e) { }
        })();
        
        main.style.cursor = 'zoom-in';
        main.removeEventListener('click', onMainImgClick);
        main.addEventListener('click', onMainImgClick);

        const attrs = document.getElementById('attributes');
        attrs.innerHTML = '';

        const vanityDefaults = ['₱400 - 14 x 14','₱430 - 14 x 16','₱450 - 16 x 19','₱470 - 16 x 21','₱500 - 17 x 25','₱550 - 20 x 24','₱650 - 21 x 28'];
        const toteDefaults = ['₱35 - 8 x 10','₱45 - 10 x 12','₱50 - 13 x 15','₱55 - 14 x 16'];
        const toteColoredDefaults = ['₱38 - 8 x 10','₱43 - 10 x 12','₱57 - 13 x 15','₱65 - 14 x 16'];
        const ringlightDefaults = ['₱500 - 18 x 21','₱550 - 22 x 22'];

        function setSelectedSize(label, price, clickedLi){
            document.querySelectorAll('.attr ul li.size-option').forEach(n => n.classList.remove('selected'));
            if (clickedLi) clickedLi.classList.add('selected');
            window._selectedSize = { label: label || null, price: (typeof price === 'number' ? Number(price) : (price ? Number(price) : null)) };
            if (window._selectedSize && window._selectedSize.price !== null) {
                document.getElementById('productPrice').textContent = formatPrice(window._selectedSize.price);
            }
        }

        if (titleLower.includes('tote') || titleLower.includes('eco jute') || titleLower.includes('katsa')) {
            const whiteSizes = (product.sizes && product.sizes.length)
                ? product.sizes.map(s => {
                    const label = (s.label || s).toString().replace(/x/,' x ');
                    const price = (typeof s.price !== 'undefined') ? ('₱' + Number(s.price)) : null;
                    return price ? `${price} - ${label}` : label;
                })
                : toteDefaults;

            const coloredSizes = toteColoredDefaults;

            const wrap1 = document.createElement('div'); wrap1.className = 'attr';
            const hdr1 = document.createElement('div'); hdr1.style.fontWeight = '700'; hdr1.textContent = 'Available Sizes White and Black (inches):';
            wrap1.appendChild(hdr1);
            const ul1 = document.createElement('ul'); ul1.style.margin = '0.5rem 0 0 0.9rem'; ul1.style.padding = '0'; ul1.style.listStyle = 'disc';
            whiteSizes.forEach(sz => {
                const li = document.createElement('li');
                li.className = 'size-option';
                let label = sz;
                let price = null;
                if (sz.indexOf('-') !== -1) {
                    const parts = sz.split('-');
                    price = parts[0].replace(/[^0-9.]/g,'');
                    label = parts.slice(1).join('-').trim();
                    li.textContent = `${parts[0].trim()} - ${label}`;
                } else {
                    label = sz;
                    li.textContent = sz + ' inches';
                }
                li.dataset.label = label;
                if (price) li.dataset.price = price;
                li.style.marginBottom = '0.25rem';
                li.addEventListener('click', function(){ setSelectedSize(this.dataset.label, this.dataset.price ? Number(this.dataset.price) : null, this); });
                ul1.appendChild(li);
            });
            (function autoSelectFirst(ul){
                const first = ul.querySelector('li.size-option');
                if (first && !window._selectedSize) {
                    setSelectedSize(first.dataset.label, first.dataset.price ? Number(first.dataset.price) : null, first);
                }
            })(ul1);
            wrap1.appendChild(ul1);
            attrs.appendChild(wrap1);

            const wrap2 = document.createElement('div'); wrap2.className = 'attr';
            const hdr2 = document.createElement('div'); hdr2.style.fontWeight = '700'; hdr2.textContent = 'Available Sizes Colored (inches):';
            wrap2.appendChild(hdr2);
            const ul2 = document.createElement('ul'); ul2.style.margin = '0.5rem 0 0 0.9rem'; ul2.style.padding = '0'; ul2.style.listStyle = 'disc';
            coloredSizes.forEach(sz => {
                const li = document.createElement('li');
                li.className = 'size-option';
                let label = sz;
                let price = null;
                if (sz.indexOf('-') !== -1) {
                    const parts = sz.split('-');
                    price = parts[0].replace(/[^0-9.]/g,'');
                    label = parts.slice(1).join('-').trim();
                    li.textContent = `${parts[0].trim()} - ${label}`;
                } else {
                    label = sz;
                    li.textContent = sz + ' inches';
                }
                li.dataset.label = label;
                if (price) li.dataset.price = price;
                li.style.marginBottom = '0.25rem';
                li.addEventListener('click', function(){ setSelectedSize(this.dataset.label, this.dataset.price ? Number(this.dataset.price) : null, this); });
                ul2.appendChild(li);
            });
            wrap2.appendChild(ul2);
            attrs.appendChild(wrap2);

        } else if (titleLower.includes('vanity') || titleLower.includes('mirror')) {
            const sizes = vanityDefaults;
            const wrap = document.createElement('div'); wrap.className = 'attr';
            const hdr = document.createElement('div'); hdr.style.fontWeight = '700'; hdr.textContent = 'Available Sizes (inches):';
            wrap.appendChild(hdr);
            const ul = document.createElement('ul'); ul.style.margin = '0.5rem 0 0 0.9rem'; ul.style.padding = '0'; ul.style.listStyle = 'disc';
            sizes.forEach(sz => {
                const li = document.createElement('li');
                li.className = 'size-option';
                let label = sz;
                let price = null;
                if (sz.indexOf('-') !== -1) {
                    const parts = sz.split('-');
                    price = parts[0].replace(/[^0-9.]/g,'');
                    label = parts.slice(1).join('-').trim();
                    li.textContent = `${parts[0].trim()} - ${label}`;
                } else {
                    label = sz;
                    li.textContent = sz + ' inches';
                }
                li.dataset.label = label;
                if (price) li.dataset.price = price;
                li.style.marginBottom = '0.25rem';
                li.addEventListener('click', function(){ setSelectedSize(this.dataset.label, this.dataset.price ? Number(this.dataset.price) : null, this); });
                ul.appendChild(li);
            });
            (function autoSelectFirst(ul){ const first = ul.querySelector('li.size-option'); if (first && !window._selectedSize) setSelectedSize(first.dataset.label, first.dataset.price ? Number(first.dataset.price) : null, first); })(ul);
            wrap.appendChild(ul);
            attrs.appendChild(wrap);

        } else if (titleLower.includes('ring') || titleLower.includes('ringlight') || titleLower.includes('ring light')) {
            const sizes = ringlightDefaults;
            const wrap = document.createElement('div'); wrap.className = 'attr';
            const hdr = document.createElement('div'); hdr.style.fontWeight = '700'; hdr.textContent = 'Available Sizes (Ringlight) (inches):';
            wrap.appendChild(hdr);
            const ul = document.createElement('ul'); ul.style.margin = '0.5rem 0 0 0.9rem'; ul.style.padding = '0'; ul.style.listStyle = 'disc';
            sizes.forEach(sz => {
                const li = document.createElement('li');
                li.className = 'size-option';
                let label = sz;
                let price = null;
                if (sz.indexOf('-') !== -1) {
                    const parts = sz.split('-');
                    price = parts[0].replace(/[^0-9.]/g,'');
                    label = parts.slice(1).join('-').trim();
                    li.textContent = `${parts[0].trim()} - ${label}`;
                } else {
                    label = sz;
                    li.textContent = sz + ' inches';
                }
                li.dataset.label = label;
                if (price) li.dataset.price = price;
                li.style.marginBottom = '0.25rem';
                li.addEventListener('click', function(){ setSelectedSize(this.dataset.label, this.dataset.price ? Number(this.dataset.price) : null, this); });
                ul.appendChild(li);
            });
            (function autoSelectFirst(ul){ const first = ul.querySelector('li.size-option'); if (first && !window._selectedSize) setSelectedSize(first.dataset.label, first.dataset.price ? Number(first.dataset.price) : null, first); })(ul);
            wrap.appendChild(ul);
            attrs.appendChild(wrap);

        } else if (product.sizes && product.sizes.length) {
            const sizes = product.sizes.map(s => {
                const label = (s.label || s).toString().replace(/x/,' x ');
                const price = (typeof s.price !== 'undefined') ? ('₱' + Number(s.price)) : null;
                return price ? `${price} - ${label}` : label;
            });
            const wrap = document.createElement('div'); wrap.className = 'attr';
            const hdr = document.createElement('div'); hdr.style.fontWeight = '700';
            hdr.textContent = titleLower.includes('ringlight') ? 'Available Sizes (Ringlight) (inches):' : 'Available Sizes (inches):';
            wrap.appendChild(hdr);
            const ul = document.createElement('ul'); ul.style.margin = '0.5rem 0 0 0.9rem'; ul.style.padding = '0'; ul.style.listStyle = 'disc';
            sizes.forEach(sz => {
                const li = document.createElement('li');
                li.className = 'size-option';
                let label = sz;
                let price = null;
                if (sz.indexOf('-') !== -1) {
                    const parts = sz.split('-');
                    price = parts[0].replace(/[^0-9.]/g,'');
                    label = parts.slice(1).join('-').trim();
                    li.textContent = `${parts[0].trim()} - ${label}`;
                } else {
                    label = sz;
                    li.textContent = sz + ' inches';
                }
                li.dataset.label = label;
                if (price) li.dataset.price = price;
                li.style.marginBottom = '0.25rem';
                li.addEventListener('click', function(){ setSelectedSize(this.dataset.label, this.dataset.price ? Number(this.dataset.price) : null, this); });
                ul.appendChild(li);
            });
            (function autoSelectFirst(ul){
                const first = ul.querySelector('li.size-option');
                if (first && !window._selectedSize) {
                    setSelectedSize(first.dataset.label, first.dataset.price ? Number(first.dataset.price) : null, first);
                }
            })(ul);
            wrap.appendChild(ul);
            attrs.appendChild(wrap);

        } else {
            product.attrs.forEach(a => { const d = document.createElement('div'); d.className='attr'; d.textContent = a; attrs.appendChild(d); });
        }
    }

    function onMainImgClick(e){
        const src = e.currentTarget.src;
        openImageModal(src);
    }

    function openImageModal(src){
        const modal = document.getElementById('imgModal');
        const img = document.getElementById('imgModalImg');
        if (modal && img) {
            img.src = src;
            img.onerror = function() {
                this.src = 'totebag.avif';
            };
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeImageModal(){
        const modal = document.getElementById('imgModal');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ closeImageModal(); } });

    function goBack(){
        const from = qParam('from');
        if(window.history.length > 1){
            window.history.back();
            setTimeout(()=>{
                if(document.visibilityState === 'visible'){
                    fallbackToFrom(from);
                }
            }, 250);
        } else {
            fallbackToFrom(from);
        }
    }

    function fallbackToFrom(from){
        const map = { profile: 'profile.html', explore: 'explore.html', saved: 'saved.html', cart: 'cart.html' };
        if(from && map[from]) window.location.href = map[from];
        else window.location.href = 'explore.html';
    }

    document.getElementById('backBtn').addEventListener('click', goBack);

    document.addEventListener('DOMContentLoaded', function(){
        const id = qParam('id');
        const slug = qParam('slug');
        let product = null;
        if(id){ product = PRODUCTS.find(p => p.id === id); }
        if(!product && slug){ product = PRODUCTS.find(p => p.slug === slug); }
        if(!product){
            const qTitle = qParam('title');
            const qPrice = qParam('price');
            const qImg = qParam('img');
            const qDesc = qParam('desc');
            const qAttrs = qParam('attrs');
            function normalizeImgPath(raw){
                if(!raw) return '';
                try {
                    let url;
                    try { url = new URL(raw, window.location.href); } catch(e) { url = null; }
                    let path = raw;
                    if (url && (url.protocol === 'http:' || url.protocol === 'https:' || raw.startsWith('/'))) {
                        path = url.pathname || raw;
                    }
                    let s = decodeURIComponent(path);
                    if (s.indexOf('%') !== -1) {
                        try { s = decodeURIComponent(s); } catch(e) { }
                    }
                    s = s.replace(/^\//, '').replace(/%20/g, ' ').trim();
                    return s;
                } catch(e){
                    return raw;
                }
            }

            if(qTitle){
                let imgVal = qImg ? normalizeImgPath(qImg) : '';
                // Parse price - handle both string and number, ensure it's a valid number
                let parsedPrice = 0;
                if (qPrice) {
                    parsedPrice = parseFloat(qPrice);
                    if (isNaN(parsedPrice)) parsedPrice = 0;
                }
                // If price is still 0, try to find product in PRODUCTS array to get default price
                if (parsedPrice === 0 || !imgVal) {
                    const foundProduct = PRODUCTS.find(p => 
                        p.title.toLowerCase() === decodeURIComponent(qTitle).toLowerCase() ||
                        p.slug === decodeURIComponent(qTitle).toLowerCase().replace(/[^a-z0-9]+/g,'-')
                    );
                    if (foundProduct) {
                        if (parsedPrice === 0) {
                            parsedPrice = foundProduct.price || 0;
                        }
                        // Also get images if not provided
                        if (!imgVal && foundProduct.imgs && foundProduct.imgs.length > 0) {
                            imgVal = foundProduct.imgs[0];
                        }
                    }
                }
                // Ensure imgVal is properly formatted
                if (!imgVal) {
                    imgVal = 'totebag.avif';
                }
                // Ensure image path doesn't start with / if it's a relative path from root
                if (imgVal && !imgVal.startsWith('http') && !imgVal.startsWith('//') && !imgVal.startsWith('data:')) {
                    // Keep relative paths as-is (they'll be resolved relative to current page)
                    if (imgVal.startsWith('/')) {
                        // Already absolute from root, keep it
                    } else {
                        // Relative path, keep as-is
                    }
                }
                
                product = {
                    id: 'p-' + Date.now(),
                    slug: qTitle.toLowerCase().replace(/[^a-z0-9]+/g,'-'),
                    title: decodeURIComponent(qTitle),
                    price: parsedPrice,
                    imgs: [imgVal],
                    desc: qDesc ? decodeURIComponent(qDesc) : '',
                    attrs: qAttrs ? decodeURIComponent(qAttrs).split('|') : [],
                    quantity: 100 // Default quantity
                };
            }
        }
       if(!product){ product = PRODUCTS[0]; }
        populate(product);
        
        // Load reviews for this product after it's populated and image is loaded
        if (product && product.title) {
            const productTitle = product.title.trim();
            console.log('Loading reviews for product title:', productTitle);
            const mainImg = document.getElementById('mainImg');
            
            // Wait for image to load before rendering reviews (so review images can use it)
            const loadReviewsAfterImage = () => {
                setTimeout(() => {
                    loadProductReviews(productTitle);
                }, 200); // Give image time to load
            };
            
            if (mainImg && mainImg.complete && mainImg.naturalWidth > 0) {
                // Image already loaded
                loadReviewsAfterImage();
            } else if (mainImg) {
                // Wait for image to load
                mainImg.addEventListener('load', loadReviewsAfterImage, { once: true });
                mainImg.addEventListener('error', loadReviewsAfterImage, { once: true }); // Load reviews even if image fails
                // Fallback timeout
                setTimeout(loadReviewsAfterImage, 1000);
            } else {
                // No image element, load reviews anyway
                setTimeout(() => {
                    loadProductReviews(productTitle);
                }, 100);
            }
        } else {
            console.warn('No product title found, cannot load reviews');
        }
        
        // Check if user wants to leave a review (from profile or order)
        const showReview = qParam('review') === 'true';
        const orderItemId = qParam('order_item_id');
        
        if(showReview || orderItemId){
            // Show review form for authenticated users
            apiFetch('/api/check_auth', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(data => {
                    if(data.authenticated){
                        document.getElementById('reviewFormContainer').style.display = 'block';
                        initStarRating();
                        // Scroll to review form
                        setTimeout(() => {
                            document.getElementById('reviewFormContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 500);
                    } else {
                        if(typeof showNotification === 'function') {
                            showNotification('Please login to leave a review', 'info');
                        }
                    }
                })
                .catch(() => {});
        }
        
        // Initialize review form
        const reviewForm = document.getElementById('reviewForm');
        if(reviewForm){
            reviewForm.addEventListener('submit', submitReview);
            initStarRating();
        }
        
        renderReviews();

        const from = qParam('from');
        const breadcrumb = document.getElementById('breadcrumb');
        if(from){ breadcrumb.textContent = 'From: ' + from.charAt(0).toUpperCase()+from.slice(1); }

        document.getElementById('addToCart').addEventListener('click', function(){
            try {
                const stored = JSON.parse(localStorage.getItem('cart') || '[]');
                const mainImgEl = document.getElementById('mainImg');
                const imgSrc = mainImgEl.getAttribute('src') || mainImgEl.src || '';
                const sizeSelectEl = document.getElementById('sizeSelect');
                let selectedSizeLabel = null;
                let selectedPrice = null;
                if (sizeSelectEl) {
                    selectedPrice = Number(sizeSelectEl.value) || 0;
                    selectedSizeLabel = sizeSelectEl.options[sizeSelectEl.selectedIndex] && sizeSelectEl.options[sizeSelectEl.selectedIndex].dataset.label;
                }
                if (!sizeSelectEl && window._selectedSize) {
                    selectedPrice = (typeof window._selectedSize.price === 'number') ? window._selectedSize.price : null;
                    selectedSizeLabel = window._selectedSize.label || null;
                }

                const item = {
                    name: product.title,
                    price: (selectedPrice !== null ? selectedPrice : product.price),
                    size: selectedSizeLabel || null,
                    image: imgSrc,
                    quantity: 1,
                    selected: false
                };

                const idx = stored.findIndex(i => i.name === item.name && i.image === item.image);
                if (idx > -1) {
                    stored[idx].quantity = (stored[idx].quantity || 100) + 1;
                } else {
                    stored.push(item);
                }
                localStorage.setItem('cart', JSON.stringify(stored));
                if (window.updateNavBadge) window.updateNavBadge();
                else if (typeof updateCartBadge === 'function') updateCartBadge();
                if(typeof showNotification === 'function') showNotification('Added to cart', 'success');
            } catch (e) {
                console.error('Add to cart failed', e);
            }
        });

        document.getElementById('saveItem').addEventListener('click', function(){
            try {
                const saved = JSON.parse(localStorage.getItem('savedBags') || '[]');
                const mainImgEl = document.getElementById('mainImg');
                const imgSrc = mainImgEl ? (mainImgEl.getAttribute('src') || mainImgEl.src || '') : '';
                const sizeSelectEl2 = document.getElementById('sizeSelect');
                let savedPrice = product.price;
                let savedSizeLabel = null;
                if (sizeSelectEl2) {
                    savedPrice = Number(sizeSelectEl2.value) || product.price;
                    savedSizeLabel = sizeSelectEl2.options[sizeSelectEl2.selectedIndex] && sizeSelectEl2.options[sizeSelectEl2.selectedIndex].dataset.label;
                }
                const itemObj = { name: product.title, price: savedPrice, image: imgSrc, size: savedSizeLabel };

                const exists = saved.some(s => (typeof s === 'string' && s === itemObj.name) || (s && s.name === itemObj.name));
                if (!exists) saved.unshift(itemObj);
                localStorage.setItem('savedBags', JSON.stringify(saved));
                if(typeof showNotification === 'function') showNotification('Saved item', 'info');
                const savedCountEl = document.getElementById('savedCount');
                if (savedCountEl) savedCountEl.textContent = `${saved.length} Saved Item${saved.length !== 1 ? 's' : ''}`;
            } catch (e) { console.error('Save item failed', e); }
        });

        if (window.updateNavBadge) window.updateNavBadge();
    });
</script>
</body>
</html>