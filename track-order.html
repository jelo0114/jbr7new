<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Track Order - JBR7 Bags</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="home.css">
  <link rel="stylesheet" href="JBR7 CSS/track-order.css">
</head>
<body>
  <header>
  <a href="home.html" class="logo">
      <img src="JBR7 BAGS LOGO.jpg" alt="JBR7 BAGS LOGO" class="logo-img" onerror="this.style.display='none'">
      <div class="logo-text">
        <h2><span>JBR7</span> BAGS</h2>
        <span class="sub-logo">MANUFACTURING</span>
      </div>
    </a>
    
    <nav>
      <a href="home.html" onclick="handleNavigate('home'); return false;" data-page="home" class="active"><i class="fas fa-home"></i> Home</a>
      <a href="explore.html" onclick="handleNavigate('explore'); return false;" data-page="explore"><i class="fas fa-compass"></i> Explore</a>
      <a href="saved.html" onclick="handleNavigate('saved'); return false;" data-page="saved"><i class="fas fa-bookmark"></i> Saved</a>
      <a href="cart.html" onclick="handleNavigate('cart'); return false;" data-page="cart"><i class="fas fa-shopping-cart"></i> Cart</a>
      <a href="contact.html" onclick="handleNavigate('contact'); return false;" data-page="contact"><i class="fas fa-envelope"></i> Contact Us</a>
      <a href="settings.html" onclick="handleNavigate('settings'); return false;" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
      <a href="#" onclick="handleNavigate('search'); return false;" data-page="search"><i class="fas fa-search"></i></a>
      <a href="#" onclick="handleNavigate('notifications'); return false;" data-page="notifications"><i class="fas fa-bell"></i></a>
      <a href="#" onclick="handleNavigate('messages'); return false;" data-page="messages"><i class="fas fa-comment"></i></a>
      <a href="profile.html" onclick="handleNavigate('profile'); return false;" data-page="profile"><i class="fas fa-user-circle"></i></a>
    </nav>
  </header>
  <div class="back-row">
    <button class="btn btn-outline" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
    <div id="breadcrumb" style="color:#666;font-weight:600;margin-left:1rem"></div>
  </div>

  <section class="track-hero">
    <div class="track-info" id="trackInfo">
      <div class="order-meta">
        <div class="order-id" id="orderId">Order #JBR7-XXXX</div>
        <div class="track-actions">
          <a href="profile.html" class="view-btn"><i class="fas fa-arrow-left"></i> Back to Orders</a>
        </div>
      </div>
      <div class="order-status" id="orderStatus">Status: Preparing</div>

      <div class="rider" id="riderBlock">
        <div class="avatar" id="riderAvatar">R</div>
        <div class="meta">
          <div id="riderName">Rider: --</div>
          <div id="riderETA">ETA: --</div>
        </div>
      </div>
    </div>
  </section>

  <div class="map-wrap">
    <!-- OpenStreetMap embed as default (no API key) -->
    <iframe id="mapFrame" class="map-frame" src="" aria-label="Order location map"></iframe>
  </div>

  <div class="progress">
    <div style="margin-bottom:.6rem;color:#666">Delivery progress</div>
    <div class="stages" id="stages">
      <div class="stage" data-step="ordered">Placed</div>
      <div class="stage" data-step="packed">Packed</div>
      <div class="stage" data-step="dispatched">Dispatched</div>
      <div class="stage" data-step="near">Near you</div>
      <div class="stage" data-step="delivered">Delivered</div>
    </div>
  </div>

  <script>
  // Helper: add user id header for API calls
  function apiFetch(url, options) {
    const opts = options || {};
    const headers = opts.headers ? { ...opts.headers } : {};
    const uid = sessionStorage.getItem('jbr7_user_id');
    if (uid) headers['X-User-Id'] = uid;
    return fetch(url, { ...opts, headers });
  }
    // Parse query params
    function qs(name) { const p = new URLSearchParams(location.search); return p.get(name); }
    const orderId = qs('order_id');
    const orderNumber = qs('order_number') || qs('order') || qs('id') || 'JBR7-UNKNOWN';
    const from = qs('from') || '';

    // Load order data from database if order_id is provided
    let orderData = null;
    if (orderId) {
      apiFetch(`/api/get_orders`, { credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
          if (data.success && data.orders) {
            orderData = data.orders.find(o => o.id == orderId);
            if (orderData) {
              updateTrackInfo(orderData);
            }
          }
        })
        .catch(e => console.error('Failed to load order:', e));
    }

    function updateTrackInfo(order) {
      document.getElementById('orderId').textContent = 'Order #' + order.order_number;
      
      // Update status
      const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
      document.getElementById('orderStatus').textContent = 'Status: ' + statusText;

      // Simple sample rider data (in real app fetch from API)
      const riders = {
        'shipped': { name: 'Alex Cruz', avatar: 'A', lat: 14.5995, lon: 120.9842, eta: '12 mins' },
        'delivered': { name: 'Maria Santos', avatar: 'M', lat: 14.6100, lon: 121.0000, eta: 'Delivered' }
      };

      const r = riders[order.status] || { name: 'Assigned Rider', avatar: 'R', lat: 14.5995, lon: 120.9842, eta: '20 mins' };
      document.getElementById('riderName').textContent = 'Rider: ' + r.name;
      document.getElementById('riderAvatar').textContent = r.avatar;
      document.getElementById('riderETA').textContent = 'ETA: ' + r.eta;

      // Set progress stages based on order status
      const stepMap = { 'processing': 1, 'shipped': 3, 'delivered': 5 };
      const currentStep = stepMap[order.status] || 2;
      const stages = document.querySelectorAll('.stage');
      stages.forEach((el, idx) => {
        if (idx < currentStep) el.classList.add('active');
        else el.classList.remove('active');
      });

      // Build OpenStreetMap static view (center on Manila
      const lat = r.lat;
      const lon = r.lon;
      const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.03}%2C${lat-0.02}%2C${lon+0.03}%2C${lat+0.02}&layer=mapnik&marker=${lat}%2C${lon}`;
      document.getElementById('mapFrame').src = mapUrl;
    }

    // Fallback if no order_id
    if (!orderId) {
      const orderNum = orderNumber.replace(/^JBR7-/, '').replace(/^0+/, '') || 'UNKNOWN';
      document.getElementById('orderId').textContent = 'Order #' + orderNumber;
      
      const riders = {
        '001': { name: 'Alex Cruz', avatar: 'A', lat: 14.5995, lon: 120.9842, eta: '12 mins' },
        '002': { name: 'Maria Santos', avatar: 'M', lat: 14.6100, lon: 121.0000, eta: '8 mins' },
        '003': { name: 'Rizal', avatar: 'R', lat: 14.5958, lon: 120.9874, eta: 'Arriving' }
      };
      
      const r = riders[orderNum] || { name: 'Assigned Rider', avatar: 'R', lat: 14.5995, lon: 120.9842, eta: '20 mins' };
      document.getElementById('riderName').textContent = 'Rider: ' + r.name;
      document.getElementById('riderAvatar').textContent = r.avatar;
      document.getElementById('riderETA').textContent = 'ETA: ' + r.eta;

      const stepMap = { '1': 3, '2': 2, '3': 4, '001': 3, '002': 2, '003': 4 };
      const currentStep = stepMap[orderNum] || 2;
      const stages = document.querySelectorAll('.stage');
      stages.forEach((el, idx) => {
        if (idx <= (currentStep-1)) el.classList.add('active');
      });

      const lat = r.lat;
      const lon = r.lon;
      const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.03}%2C${lat-0.02}%2C${lon+0.03}%2C${lat+0.02}&layer=mapnik&marker=${lat}%2C${lon}`;
      document.getElementById('mapFrame').src = mapUrl;
    }

  // Back behavior
  const backEl = document.getElementById('backBtn');
  if (backEl) backEl.addEventListener('click', function(e){ e.preventDefault(); goBack(); });
    function goBack(){
      if (history.length > 1) return history.back();
      if (from) {
        switch(from) {
          case 'profile': return window.location.href = 'profile.html';
          case 'explore': return window.location.href = 'explore.html';
          case 'saved': return window.location.href = 'saved.html';
          case 'cart': return window.location.href = 'cart.html';
        }
      }
      window.location.href = 'profile.html';
    }

    // Populate breadcrumb (From:) similar to view.html
    const breadcrumb = document.getElementById('breadcrumb');
    if (breadcrumb) {
      if(from){ breadcrumb.textContent = 'From: ' + from.charAt(0).toUpperCase() + from.slice(1); }
    }
  </script>
  <script src="jbr7js/home.js"></script>
  <script src="jbr7js/notifications.js"></script>
</body>
</html>
