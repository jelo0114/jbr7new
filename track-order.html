<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Track Order - JBR7 Bags</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="home.css">
  <link rel="stylesheet" href="JBR7 CSS/track-order.css">
</head>
<body>
  <header>
  <a href="home.html" class="logo">
      <img src="JBR7 BAGS LOGO.jpg" alt="JBR7 BAGS LOGO" class="logo-img" onerror="this.style.display='none'">
      <div class="logo-text">
        <h2><span>JBR7</span> BAGS</h2>
        <span class="sub-logo">MANUFACTURING</span>
      </div>
    </a>
    
    <nav>
      <a href="home.html" onclick="handleNavigate('home'); return false;" data-page="home" class="active"><i class="fas fa-home"></i> Home</a>
      <a href="explore.html" onclick="handleNavigate('explore'); return false;" data-page="explore"><i class="fas fa-compass"></i> Explore</a>
      <a href="saved.html" onclick="handleNavigate('saved'); return false;" data-page="saved"><i class="fas fa-bookmark"></i> Saved</a>
      <a href="cart.html" onclick="handleNavigate('cart'); return false;" data-page="cart"><i class="fas fa-shopping-cart"></i> Cart</a>
      <a href="contact.html" onclick="handleNavigate('contact'); return false;" data-page="contact"><i class="fas fa-envelope"></i> Contact Us</a>
      <a href="settings.html" onclick="handleNavigate('settings'); return false;" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
      <a href="#" onclick="handleNavigate('search'); return false;" data-page="search"><i class="fas fa-search"></i></a>
      <a href="#" onclick="handleNavigate('notifications'); return false;" data-page="notifications"><i class="fas fa-bell"></i></a>
      <a href="#" onclick="handleNavigate('messages'); return false;" data-page="messages"><i class="fas fa-comment"></i></a>
      <a href="profile.html" onclick="handleNavigate('profile'); return false;" data-page="profile"><i class="fas fa-user-circle"></i></a>
    </nav>
  </header>
  <div class="back-row">
    <button class="btn btn-outline" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
    <div id="breadcrumb" style="color:#666;font-weight:600;margin-left:1rem"></div>
  </div>

  <section class="track-hero">
    <div class="track-info" id="trackInfo">
      <div class="order-meta">
        <div class="order-id" id="orderId">Order #JBR7-XXXX</div>
        <div class="track-actions">
          <a href="profile.html" class="view-btn"><i class="fas fa-arrow-left"></i> Back to Orders</a>
        </div>
      </div>
      <div class="order-status" id="orderStatus">Status: Preparing</div>
    </div>
  </section>

  <div class="track-timeline-wrap">
    <h3 class="track-timeline-title">Order progress</h3>
    <div class="track-timeline" id="trackTimeline">
      <div class="track-step" data-step="1">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Order Placed</span>
        </div>
        <p class="track-step-desc">The customer has successfully placed an order on the JBR ONLINE website. Order details are recorded in the system.</p>
      </div>
      <div class="track-step" data-step="2">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Payment Confirmed</span>
        </div>
        <p class="track-step-desc">The system verifies that the payment has been successfully processed. The order is now ready for preparation.</p>
      </div>
      <div class="track-step" data-step="3">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Order Being Prepared</span>
        </div>
        <p class="track-step-desc">JBR staff prepares the ordered items, checks product quality, and packages the items for shipment.</p>
      </div>
      <div class="track-step" data-step="4">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Order Ready for Pickup</span>
        </div>
        <p class="track-step-desc">The package is ready and waiting to be picked up by the delivery service or courier.</p>
      </div>
      <div class="track-step" data-step="5">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Picked Up by Courier</span>
        </div>
        <p class="track-step-desc">The courier has collected the package from JBR Manufacturing for delivery.</p>
      </div>
      <div class="track-step" data-step="6">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">In Transit</span>
        </div>
        <p class="track-step-desc">The order is on the way to the customer. The package may pass through sorting hubs or delivery centers.</p>
      </div>
      <div class="track-step" data-step="7">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Out for Delivery</span>
        </div>
        <p class="track-step-desc">The courier is delivering the package to the customer's address.</p>
      </div>
      <div class="track-step" data-step="8">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Delivered</span>
        </div>
        <p class="track-step-desc">The order has been successfully delivered to the customer. Proof of delivery may be available.</p>
      </div>
      <div class="track-step" data-step="9">
        <div class="track-step-head">
          <span class="track-step-dot"></span>
          <span class="track-step-name">Order Completed</span>
        </div>
        <p class="track-step-desc">The transaction is fully completed, and the order is marked as finished in the system.</p>
      </div>
    </div>
  </div>

  <script>
  // Helper: add user id header for API calls
  function apiFetch(url, options) {
    const opts = options || {};
    const headers = opts.headers ? { ...opts.headers } : {};
    const uid = sessionStorage.getItem('jbr7_user_id');
    if (uid) headers['X-User-Id'] = uid;
    return fetch(url, { ...opts, headers });
  }
    // Parse query params
    function qs(name) { const p = new URLSearchParams(location.search); return p.get(name); }
    const orderId = qs('order_id');
    const orderNumber = qs('order_number') || qs('order') || qs('id') || 'JBR7-UNKNOWN';
    const from = qs('from') || '';

    if (orderNumber && orderNumber !== 'JBR7-UNKNOWN') {
      document.getElementById('orderId').textContent = 'Order #' + orderNumber;
    }

    // Load order data from database (by order_id or by order_number)
    function loadAndShowOrder() {
      apiFetch('/api/get_orders', { credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
          if (!data.success || !data.orders) return;
          var order = orderId
            ? data.orders.find(function(o) { return o.id == orderId; })
            : data.orders.find(function(o) { return String(o.order_number || '') === String(orderNumber) || String(o.id) === String(orderNumber); });
          if (order) updateTrackInfo(order);
          else if (!orderId) setTimelineActive(3);
        })
        .catch(function(e) { console.error('Failed to load order:', e); if (!orderId) setTimelineActive(3); });
    }
    if (orderId || orderNumber) loadAndShowOrder();

    // Map backend status to timeline step (1-9). processing→3, confirmed→4, shipped→7, delivered→9, cancelled→0
    function getStepForStatus(status) {
      const s = (status || '').toLowerCase();
      if (s === 'cancelled') return 0;
      if (s === 'delivered') return 9;
      if (s === 'shipped') return 7;
      if (s === 'confirmed') return 4;
      return 3; // processing
    }

    function setTimelineActive(completedStep) {
      const steps = document.querySelectorAll('.track-step');
      steps.forEach(function(el) {
        const stepNum = parseInt(el.getAttribute('data-step'), 10);
        if (completedStep > 0 && stepNum <= completedStep) el.classList.add('active');
        else el.classList.remove('active');
      });
    }

    function updateTrackInfo(order) {
      document.getElementById('orderId').textContent = 'Order #' + order.order_number;

      const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
      document.getElementById('orderStatus').textContent = 'Status: ' + statusText;

      const completedStep = getStepForStatus(order.status);
      setTimelineActive(completedStep);
    }

  // Back behavior
  const backEl = document.getElementById('backBtn');
  if (backEl) backEl.addEventListener('click', function(e){ e.preventDefault(); goBack(); });
    function goBack(){
      if (history.length > 1) return history.back();
      if (from) {
        switch(from) {
          case 'profile': return window.location.href = 'profile.html';
          case 'explore': return window.location.href = 'explore.html';
          case 'saved': return window.location.href = 'saved.html';
          case 'cart': return window.location.href = 'cart.html';
        }
      }
      window.location.href = 'profile.html';
    }

    // Populate breadcrumb (From:) similar to view.html
    const breadcrumb = document.getElementById('breadcrumb');
    if (breadcrumb) {
      if(from){ breadcrumb.textContent = 'From: ' + from.charAt(0).toUpperCase() + from.slice(1); }
    }
  </script>
  <script src="jbr7js/home.js"></script>
  <script src="jbr7js/notifications.js"></script>
</body>
</html>
